<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="A university project">
<title>ENGG3000 Vertical Lift Bridge</title>

<link rel='canonical' href='http://localhost:1313/p/engg3000-vertical-lift-bridge/'>

<link rel="stylesheet" href="/scss/style.min.fb8c6c530cc907ade9bc970de246ba50b81a37cdb893b461e84f28b3851f62e4.css"><meta property='og:title' content="ENGG3000 Vertical Lift Bridge">
<meta property='og:description' content="A university project">
<meta property='og:url' content='http://localhost:1313/p/engg3000-vertical-lift-bridge/'>
<meta property='og:site_name' content='MT12'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='University Project' /><meta property='article:tag' content='C&#43;&#43;' /><meta property='article:tag' content='Java' /><meta property='article:tag' content='ESP32' /><meta property='article:tag' content='Hardware' /><meta property='article:tag' content='Networks' /><meta property='article:published_time' content='2025-11-10T01:00:00&#43;11:00'/><meta property='article:modified_time' content='2025-11-10T01:00:00&#43;11:00'/><meta property='og:image' content='http://localhost:1313/p/engg3000-vertical-lift-bridge/cover.png' />
<meta name="twitter:title" content="ENGG3000 Vertical Lift Bridge">
<meta name="twitter:description" content="A university project"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/p/engg3000-vertical-lift-bridge/cover.png' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Audiowide|Sofia|Trirong|Exo+2">
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu16584542358284784499.jpg" width="300"
                            height="299" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">MT12</a></h1>
            <h2 class="site-description">Software Engineering and Cyber Security Student</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/MT1218'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://linkedin.com/in/manav-thobhani-352018266'
                        target="_blank"
                        title="LinkedIn"
                        rel="me"
                    >
                        
                        
                            <svg fill="#FFFFFF" xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 50 50" width="50px" height="50px">
    <path d="M 9 4 C 6.2504839 4 4 6.2504839 4 9 L 4 41 C 
    4 43.749516 6.2504839 46 9 46 L 41 46 C 43.749516 46 46 43.749516 46 
    41 L 46 9 C 46 6.2504839 43.749516 4 41 4 L 9 4 z M 9 6 L 41 6 C 42.668484 
    6 44 7.3315161 44 9 L 44 41 C 44 42.668484 42.668484 44 41 44 L 9 44 C 7.3315161 
    44 6 42.668484 6 41 L 6 9 C 6 7.3315161 7.3315161 6 9 6 z M 14 11.011719 C 12.904779 
    11.011719 11.919219 11.339079 11.189453 11.953125 C 10.459687 12.567171 10.011719 
    13.484511 10.011719 14.466797 C 10.011719 16.333977 11.631285 17.789609 13.691406 
    17.933594 A 0.98809878 0.98809878 0 0 0 13.695312 17.935547 A 0.98809878 0.98809878 0 0 0 14 
    17.988281 C 16.27301 17.988281 17.988281 16.396083 17.988281 14.466797 A 0.98809878 0.98809878 
    0 0 0 17.986328 14.414062 C 17.884577 12.513831 16.190443 11.011719 14 11.011719 z M 14 12.988281 
    C 15.392231 12.988281 15.94197 13.610038 16.001953 14.492188 C 15.989803 15.348434 15.460091 16.011719 
    14 16.011719 C 12.614594 16.011719 11.988281 15.302225 11.988281 14.466797 C 11.988281 14.049083 
    12.140703 13.734298 12.460938 13.464844 C 12.78117 13.19539 13.295221 12.988281 14 12.988281 z 
    M 11 19 A 1.0001 1.0001 0 0 0 10 20 L 10 39 A 1.0001 1.0001 0 0 0 11 40 L 17 40 A 1.0001 
    1.0001 0 0 0 18 39 L 18 33.134766 L 18 20 A 1.0001 1.0001 0 0 0 17 19 L 11 19 z M 20 19 A 1.0001 
    1.0001 0 0 0 19 20 L 19 39 A 1.0001 1.0001 0 0 0 20 40 L 26 40 A 1.0001 1.0001 0 0 0 27 39 L 27 29 C 27 28.170333 27.226394 27.345035 27.625 26.804688 C 
    28.023606 26.264339 28.526466 25.940057 29.482422 25.957031 C 30.468166 25.973981 30.989999 26.311669 31.384766 26.841797 C 31.779532 27.371924 32 28.166667 
    32 29 L 32 39 A 1.0001 1.0001 0 0 0 33 40 L 39 40 A 1.0001 1.0001 0 0 0 40 39 L 40 28.261719 C 40 25.300181 39.122788 22.95433 37.619141 21.367188 C 36.115493 
    19.780044 34.024172 19 31.8125 19 C 29.710483 19 28.110853 19.704889 27 20.423828 L 27 20 A 1.0001 1.0001 0 0 0 26 19 L 20 19 z M 12 21 L 16 21 L 16 33.134766 L 16 38 L 12 
    38 L 12 21 z M 21 21 L 25 21 L 25 22.560547 A 1.0001 1.0001 0 0 0 26.798828 23.162109 C 26.798828 23.162109 28.369194 21 31.8125 21 C 33.565828 21 35.069366 21.582581 36.167969 22.742188 C 
    37.266572 23.901794 38 25.688257 38 28.261719 L 38 38 L 34 38 L 34 29 C 34 27.833333 33.720468 26.627107 32.990234 25.646484 C 32.260001 24.665862 31.031834 23.983076 29.517578 23.957031 C 
    27.995534 23.930001 26.747519 24.626988 26.015625 25.619141 C 25.283731 26.611293 25 27.829667 25 29 L 25 38 L 21 38 L 21 21 z" stroke="#000000" stroke-width="0.75"/>
</svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
            
            <li  class = "sidebar-item">
                <a href='/' >
                    
                    
                    
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                    
                    <span>Home</span>
                </a>
            </li>
        
            
            <li  class = "sidebar-item">
                <a href='/about/' >
                    
                    
                    
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                    
                    <span>About</span>
                </a>
            </li>
        
            
            <li  class = "sidebar-item">
                <a href='/archives/' >
                    
                    
                    
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                    
                    <span>Archives</span>
                </a>
            </li>
        
            
            <li  class = "sidebar-item">
                <a href='/categories/' >
                    
                    
                    
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 50 50" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
<path d="M 5 4 C 3.3544268 4 2 5.3555411 2 7 L 2 16 L 2 26 L 2 43 C 2 44.644459 3.3544268 46 5 46 L 45 46 C 46.645063 46 48 44.645063 48 43 L 48 26 L 48 16 L 48 11 C 48 9.3549372 46.645063 8 45 8 L 18 8 C 18.08657 8 17.96899 8.000364 17.724609 7.71875 C 17.480227 7.437136 17.179419 6.9699412 16.865234 6.46875 C 16.55105 5.9675588 16.221777 5.4327899 15.806641 4.9628906 C 15.391504 4.4929914 14.818754 4 14 4 L 5 4 z M 5 6 L 14 6 C 13.93925 6 14.06114 6.00701 14.308594 6.2871094 C 14.556051 6.5672101 14.857231 7.0324412 15.169922 7.53125 C 15.482613 8.0300588 15.806429 8.562864 16.212891 9.03125 C 16.619352 9.499636 17.178927 10 18 10 L 45 10 C 45.562937 10 46 10.437063 46 11 L 46 13.1875 C 45.685108 13.07394 45.351843 13 45 13 L 5 13 C 4.6481575 13 4.3148915 13.07394 4 13.1875 L 4 7 C 4 6.4364589 4.4355732 6 5 6 z M 5 15 L 45 15 C 45.56503 15 46 15.43497 46 16 L 46 26 L 46 43 C 46 43.562937 45.562937 44 45 44 L 5 44 C 4.4355732 44 4 43.563541 4 43 L 4 26 L 4 16 C 4 15.43497 4.4349698 15 5 15 z"/>
</svg>



                    
                    <span>Categories</span>
                </a>
            </li>
        
            
            <li  class = "sidebar-item">
                <a href='/tags/' >
                    
                    
                    
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11 3L20 12a1.5 1.5 0 0 1 0 2L14 20a1.5 1.5 0 0 1 -2 0L3 11v-4a4 4 0 0 1 4 -4h4" />
  <circle cx="9" cy="9" r="2" />
</svg>



                    
                    <span>Tags</span>
                </a>
            </li>
        
            
            <li  class = "sidebar-item">
                <a href='/search/' >
                    
                    
                    
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                    
                    <span>Search</span>
                </a>
            </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
        
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#what-was-the-project">What was the Project?</a></li>
    <li><a href="#overview-of-the-system">Overview of the System</a>
      <ol>
        <li><a href="#requirements">Requirements</a></li>
        <li><a href="#system-architecture">System Architecture</a>
          <ol>
            <li><a href="#esp32-bridge-controller">ESP32 Bridge Controller</a></li>
            <li><a href="#java-remote-interface">Java Remote Interface</a></li>
            <li><a href="#high-level-diagram">High Level Diagram</a></li>
          </ol>
        </li>
        <li><a href="#technologies-used">Technologies Used</a>
          <ol>
            <li><a href="#esp32-development">ESP32 Development</a></li>
            <li><a href="#esp32-peripherals">ESP32 Peripherals</a></li>
            <li><a href="#java-development">Java Development</a></li>
            <li><a href="#network-configuration">Network Configuration</a></li>
            <li><a href="#testing-and-simulation">Testing and Simulation</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#esp32">ESP32</a>
      <ol>
        <li><a href="#purpose-and-the-operating-modes">Purpose and the Operating Modes</a></li>
        <li><a href="#types-and-state-definitions">Types and State Definitions</a></li>
        <li><a href="#state-machine-and-multi-core-architecture">State Machine and Multi-Core Architecture</a>
          <ol>
            <li><a href="#concurrency-justification">Concurrency Justification</a></li>
            <li><a href="#freertos-tasks-and-queues">FreeRTOS Tasks and Queues</a></li>
            <li><a href="#mutex-protection">Mutex Protection</a></li>
            <li><a href="#automatic-mode-state-machine">Automatic Mode State Machine</a></li>
          </ol>
        </li>
        <li><a href="#light-control">Light Control</a></li>
        <li><a href="#sensor-readings">Sensor Readings</a></li>
        <li><a href="#motor-control">Motor Control</a></li>
        <li><a href="#communication-with-java-program">Communication with Java Program</a>
          <ol>
            <li><a href="#message-types">Message Types</a>
              <ol>
                <li><a href="#status-updates-esp32----java">Status Updates (ESP32 &ndash;&gt; Java)</a></li>
                <li><a href="#event-messages-esp32----java">Event Messages (ESP32 &ndash;&gt; Java)</a></li>
                <li><a href="#commands-java----esp32">Commands (Java &ndash;&gt; ESP32)</a></li>
                <li><a href="#heartbeat-java----esp32">Heartbeat (Java &ndash;&gt; ESP32)</a></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#safety-features">Safety Features</a>
          <ol>
            <li><a href="#weight-monitoring">Weight Monitoring</a></li>
            <li><a href="#boat-clearance-detection">Boat Clearance Detection</a></li>
            <li><a href="#traffic-detection-before-mode-switching">Traffic Detection Before Mode Switching</a></li>
            <li><a href="#mode-change-queuing">Mode Change Queuing</a></li>
            <li><a href="#diagnostic-and-recovery-mode">Diagnostic and Recovery Mode</a></li>
            <li><a href="#timeout-protection">Timeout Protection</a></li>
            <li><a href="#testing-sequence">Testing Sequence</a></li>
          </ol>
        </li>
        <li><a href="#final-look-of-the-esp32-and-bridge">Final Look of the ESP32 and Bridge</a></li>
      </ol>
    </li>
    <li><a href="#java-program">Java Program</a>
      <ol>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#multithreading">Multithreading</a>
          <ol>
            <li><a href="#send-class">Send Class</a></li>
            <li><a href="#receive-class">Receive Class</a></li>
            <li><a href="#heartbeat-class">Heartbeat Class</a></li>
            <li><a href="#main">Main</a></li>
          </ol>
        </li>
        <li><a href="#controls-and-displays">Controls and Displays</a></li>
      </ol>
    </li>
    <li><a href="#lessons-learnt">Lessons Learnt</a></li>
    <li><a href="#things-id-do-differently">Things I&rsquo;d Do Differently</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/engg3000-vertical-lift-bridge/">
                <img src="/p/engg3000-vertical-lift-bridge/cover_hu17788977227294924615.png"
                        srcset="/p/engg3000-vertical-lift-bridge/cover_hu17788977227294924615.png 800w, /p/engg3000-vertical-lift-bridge/cover_hu725581790025395832.png 1600w"
                        width="800" 
                        height="450" 
                        loading="lazy"
                        alt="Featured image of post ENGG3000 Vertical Lift Bridge" />
                
            </a>
        </div>
    

    <div class="article-details">
    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/engg3000-vertical-lift-bridge/">ENGG3000 Vertical Lift Bridge</a>
        </h2>
        
        
        <h3 class="article-subtitle">
            A university project
        </h3>
        
    </div>

    
    <header class="article-category">
        <svg xmlns="http://www.w3.org/2000/svg" class="article-category-logo" width="28" height="28" viewBox="0 0 50 50" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M 5 4 C 3.3544268 4 2 5.3555411 2 7 L 2 16 L 2 26 L 2 43 C 2 44.644459 3.3544268 46 5 46 L 45 46 C 46.645063 46 48 44.645063 48 43 L 48 26 L 48 16 L 48 11 C 48 9.3549372 46.645063 8 45 8 L 18 8 C 18.08657 8 17.96899 8.000364 17.724609 7.71875 C 17.480227 7.437136 17.179419 6.9699412 16.865234 6.46875 C 16.55105 5.9675588 16.221777 5.4327899 15.806641 4.9628906 C 15.391504 4.4929914 14.818754 4 14 4 L 5 4 z M 5 6 L 14 6 C 13.93925 6 14.06114 6.00701 14.308594 6.2871094 C 14.556051 6.5672101 14.857231 7.0324412 15.169922 7.53125 C 15.482613 8.0300588 15.806429 8.562864 16.212891 9.03125 C 16.619352 9.499636 17.178927 10 18 10 L 45 10 C 45.562937 10 46 10.437063 46 11 L 46 13.1875 C 45.685108 13.07394 45.351843 13 45 13 L 5 13 C 4.6481575 13 4.3148915 13.07394 4 13.1875 L 4 7 C 4 6.4364589 4.4355732 6 5 6 z M 5 15 L 45 15 C 45.56503 15 46 15.43497 46 16 L 46 26 L 46 43 C 46 43.562937 45.562937 44 45 44 L 5 44 C 4.4355732 44 4 43.563541 4 43 L 4 26 L 4 16 C 4 15.43497 4.4349698 15 5 15 z"/>
        </svg>            
        
            <a class = "article-category-button" href="/categories/coding-projects/" >
                Coding Projects
            </a>
        
    </header>
    

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 10, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    52 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="what-was-the-project">What was the Project?
</h1><p>This was a really fun project I got to work on for my ENGG3000 unit at university. The objective was simple: we had to build and demonstrate a small-scale vertical lift bridge from scratch. It was a multi-disciplinary project with two groups for each bridge, a <strong>Systems</strong> Group (Software, Electrical and Mechatronics majors) and a <strong>Structures</strong> Group (Civil and Mechanical majors).</p>
<p>As part of the systems group we were responsible for creating all the hardware and software that would allow full control of the bridge: sensors (ultrasonic and weight sensors), power systems, motor control through Pulse Width Modulation (PWM) signals, and LED traffic light systems using shift registers. My role in all this was two-fold, create a multi-threaded C++ program for an ESP32 which would act as the bridge controller and create a remote user interface that would allow users to monitor and control the bridge.</p>
<p>This post is going to go through the entire project; from requirements to the final product that we delivered alongside all the design decisions made and challenges faced (all the fun stuff). This is what the bridge and remote interface looked like for the final demonstration:</p>
<p><img src="/p/engg3000-vertical-lift-bridge/images/demonstration.jpeg"
	width="2048"
	height="1536"
	srcset="/p/engg3000-vertical-lift-bridge/images/demonstration_hu15633905292244647343.jpeg 480w, /p/engg3000-vertical-lift-bridge/images/demonstration_hu12247443270536040223.jpeg 1024w"
	loading="lazy"
	
		alt="Demonstration Image"
	
	
		class="gallery-image" 
		data-flex-grow="133"
		data-flex-basis="320px"
	
></p>
<p>All the source code for this project, that is referenced in this post, can be found in these two repositories (totally has a descriptive commit messages):</p>
<p><a class="link" href="https://github.com/MT1218/ENGG3000-ESP32"  target="_blank" rel="noopener"
    >ESP32 Bridge Controller Source Code</a></p>
<p><a class="link" href="https://github.com/MT1218/ENGG3000-Java-Program"  target="_blank" rel="noopener"
    >Java GUI Source Code</a></p>
<p>If you don&rsquo;t want to read the entire code explanation, you can <a class="link" href="#final-look-of-the-esp32-and-bridge" >skip all the yap and go to the photos/video.</a></p>
<h1 id="overview-of-the-system">Overview of the System
</h1><h2 id="requirements">Requirements
</h2><p>A week before the unit started, we were given specific requirements for what the bridge should be able to do. These were the relevant requirements summarised from the specifications:</p>
<ol>
<li>The bridge is to have an automatic control system that detects the arrival of shipping traffic.</li>
<li>When shipping traffic arrives, it should signal for the boat to wait, safely signal vehicular and pedestrian traffic to stop, and then open the bridge.</li>
<li>Once the shipping traffic has passed through safely, the bridge should close and allow vehicular and pedestrian traffic to resume crossing the river.</li>
<li>The control system must provide some form of local visual indication of the state of the sensors and system.</li>
<li>It must also provide a remote user interface on a computer that shows the state of the bridge, sensors and system, and allow the control of all bridge operations including overriding sensor inputs.</li>
<li>Ideally, the user interface will be wirelessly connected to the control system via Wi-Fi.</li>
<li>The bill of materials for building the bridge must not exceed AUD$100.</li>
</ol>
<h2 id="system-architecture">System Architecture
</h2><p>Based on the requirements above my team decided on using an <strong>ESP32 DevKit v1</strong> board as the bridge controller and a Java program for the remote interface. These two components were the main parts and would communicate wirelessly. This is a really high level overview of the main functions of the two components:</p>
<h3 id="esp32-bridge-controller">ESP32 Bridge Controller
</h3><ul>
<li>Runs multi-threaded FreeRTOS tasks across two CPU cores.</li>
<li>Controls all the sensors, motors and traffic lights.</li>
<li>Is able to run in two modes; automatic and override.</li>
<li>Sends status updates to the Java program every second over UDP.</li>
</ul>
<h3 id="java-remote-interface">Java Remote Interface
</h3><ul>
<li>Shows the real time state of the bridge.</li>
<li>Allows the operator to switch between automatic and override modes.</li>
<li>Allow control of the bridge, gates and lights in override mode.</li>
<li>Sends a heartbeat message to the ESP32 every 2 seconds to maintain connection.</li>
</ul>
<h3 id="high-level-diagram">High Level Diagram
</h3><p>Putting all that into a visual perspective:</p>
<p><img src="/p/engg3000-vertical-lift-bridge/images/high_level_overview.png"
	width="391"
	height="421"
	srcset="/p/engg3000-vertical-lift-bridge/images/high_level_overview_hu6305580517951938002.png 480w, /p/engg3000-vertical-lift-bridge/images/high_level_overview_hu3880838252328172776.png 1024w"
	loading="lazy"
	
		alt="High Level System Architecture"
	
	
		class="gallery-image" 
		data-flex-grow="92"
		data-flex-basis="222px"
	
></p>
<h2 id="technologies-used">Technologies Used
</h2><p>Since there were two parts to this project (the Java program and ESP32 C++ program) there was a variety of technologies that I got to work with. I&rsquo;ve summarised them as best as I could below.</p>
<h3 id="esp32-development">ESP32 Development
</h3><ul>
<li><code>PlatformIO VSCode Extension</code> for development and building.</li>
<li><code>Arduino Framework</code> for the ESP32 programming.</li>
<li><code>FreeRTOS</code> for managing the multi-threaded tasks.</li>
<li><code>WifiUDP</code> Library for UDP network communications.</li>
<li><code>LEDC</code> for PWM motor and buzzer control.</li>
<li><code>PulseIn</code> for ultrasonic sensor readings.</li>
</ul>
<h3 id="esp32-peripherals">ESP32 Peripherals
</h3><ul>
<li>6x <a class="link" href="https://core-electronics.com.au/33v-ultrasonic-distance-sensor.html"  target="_blank" rel="noopener"
    >HC-SR04 Ultrasonic Sensors</a> (traffic detection, bridge position and clearance).</li>
<li>1x <a class="link" href="https://core-electronics.com.au/lm258p-dual-channel-op-amp-through-hole-sparkfun.html"  target="_blank" rel="noopener"
    >LM258P Op-Amp</a> (weight on bridge sensing through the motor current).</li>
<li>2x <a class="link" href="https://core-electronics.com.au/shift-register-8-bit-sn74hc595.html"  target="_blank" rel="noopener"
    >SN74HC595N Shift Registers</a> (LED traffic light control).</li>
<li>1x <a class="link" href="https://core-electronics.com.au/feetech-fs5109r-standard-servo-10kg-cm.html"  target="_blank" rel="noopener"
    >FS5109R Servo</a> (motor to control the bridge).</li>
<li>1x <a class="link" href="https://core-electronics.com.au/feetech-fs90-1-5kgcm-micro-servo-9g.html"  target="_blank" rel="noopener"
    >FS90 9g Micro Servo</a> (motor to control boom gates (closed when bridge is open to stop road traffic)).</li>
<li>1x <a class="link" href="https://core-electronics.com.au/large-enclosed-piezo-element-w-wires.html"  target="_blank" rel="noopener"
    >Piezo Buzzer</a> (buzzer for audio warnings while the bridge is moving).</li>
<li>1x Photo-Resistor, couldn&rsquo;t find the link :/ (used for controlling the white bridge lights and allow them to act as street lights).</li>
</ul>
<h3 id="java-development">Java Development
</h3><ul>
<li><code>Java Swing</code> for the GUI.</li>
<li><code>DatagramSocket</code> and <code>DatagramPacket</code> for UDP network communication.</li>
<li><code>Thread</code> library for concurrent send and receive operations.</li>
</ul>
<h3 id="network-configuration">Network Configuration
</h3><ul>
<li>UDP on <code>port 3031</code> (ESP32 listens on this) and <code>port 3032</code> (the Java program listens on this).</li>
<li>There is a <code>standard text based message format</code> where key-value pairs are pipe-delimited.</li>
<li>Bridge <code>status updates</code> every 1 second.</li>
<li><code>Heartbeat messages</code> from the Java program to the ESP32 every 2 seconds.</li>
</ul>
<h3 id="testing-and-simulation">Testing and Simulation
</h3><ul>
<li>For testing we used <code>Wokwi</code> (paid for a private gateway) which is an ESP32 simulator.</li>
<li>Used pre-processing directives (<strong>#define WOKWI_SIMULATION</strong> and <strong>#ifdef WOKWI_SIMULATION</strong>) to mock sensor readings.</li>
</ul>
<h1 id="esp32">ESP32
</h1><p>Now for the fun part; the actual code implementation for the ESP32. The code base is pretty large so I can&rsquo;t explain it line by line. Instead I&rsquo;ve decided to explore and go through the code based on the main functionalities and features (and just anything that I found really fun to learn).</p>
<h2 id="purpose-and-the-operating-modes">Purpose and the Operating Modes
</h2><p>The main purpose of all the code on the ESP32 is to essentially be the &ldquo;brain&rdquo; of the bridge system. So this means continuously running and monitoring the sensor inputs, controlling the servos based on this input and controlling all the traffic flow. There are two main modes in which the ESP32 can operate:</p>
<p><strong>Automatic Mode</strong> (Default):</p>
<ul>
<li>In this mode the ESP32 continuously monitors the road and boat traffic sensors.</li>
<li>Based on whether the bridge is open or closed, if there is traffic waiting for bridge to change its state (e.g. boats waiting for bridge to open), the opening/closing sequences will be initiated. The two sequences are <code>OPENING_FOR_BOATS</code> and <code>CLOSING_FOR_CARS</code>.</li>
<li>After the sequence is complete the bridge will go into either a <code>CARS_PASSING</code> or <code>BOATS_PASSING</code> state (for 10 seconds) to allow for traffic to pass.</li>
<li>After the passing states the bridge will go into the <code>IDLE</code> state. From this state the cycle will repeat depending on input from the traffic sensors.</li>
<li>This mode doesn&rsquo;t require any user/operator for it work.</li>
</ul>
<p><strong>Override Mode</strong> (Manual Control):</p>
<ul>
<li>This mode allows the operators to individually control all parts of the bridge (traffic lights, buzzer and bridge/gate positions).</li>
<li>The operator can also trigger the <code>OPENING_FOR_BOATS</code> and <code>CLOSING_FOR_CARS</code> sequences alongside a <code>TESTING</code> sequence.</li>
<li>Commands are queued and there is a max of 3 to prevent a buffer overflow.</li>
<li>There are safety checks to prevent the bridge from entering this mode if there is traffic. This is implemented since the use case for this mode is to allow for a bridge operator to test the bridge and its functions not for manually managing traffic.</li>
</ul>
<h2 id="types-and-state-definitions">Types and State Definitions
</h2><p>For the different states that all the various parts of the system can be in, I&rsquo;ve created readable enums to prevent any invalid states during compilation or while the program is running:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cm">/* Global Enums */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Represents whether code is in automatic or override state, auto by default
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">OperationalMode</span> <span class="p">{</span> <span class="n">AUTOMATIC</span><span class="p">,</span> <span class="n">OVERRIDE</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Represents whether the bridge is opened, closed or in an unknown state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">BridgeGateState</span> <span class="p">{</span> <span class="n">CLOSED</span><span class="p">,</span> <span class="n">OPEN</span><span class="p">,</span> <span class="n">UNKNOWN</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Represents state of boat and road lights
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">LightColours</span> <span class="p">{</span> <span class="n">RED</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">YELLOW</span><span class="p">,</span> <span class="n">NONE</span><span class="p">,</span> <span class="n">ALL</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Represents whether bridge lights should be on or off
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">BridgeLightState</span> <span class="p">{</span> <span class="n">ON</span><span class="p">,</span> <span class="n">OFF</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Represents whether the buzzer sound should be on or off
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">BuzzerSound</span> <span class="p">{</span> <span class="n">SOUND</span><span class="p">,</span> <span class="n">NO_SOUND</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Represents which motor to move
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">Motor</span> <span class="p">{</span> <span class="n">BRIDGE</span><span class="p">,</span> <span class="n">GATE</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Represents which sensor to read from
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">AdcValue</span> <span class="p">{</span> <span class="n">PHOTO_RESISTOR</span><span class="p">,</span> <span class="n">BRIDGE_WEIGHT</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Bridge sequence state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">BridgeSequenceState</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">IDLE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">OPENING_FOR_BOATS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">BOATS_PASSING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">CLOSING_FOR_CARS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">CARS_PASSING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">DIAGNOSTIC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">TESTING</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Represents which stage the bridge is at while moving
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">BridgeMovementState</span> <span class="p">{</span> <span class="n">STATE_ONE</span><span class="p">,</span> <span class="n">STATE_TWO</span><span class="p">,</span> <span class="n">STATE_THREE</span><span class="p">,</span> <span class="n">STATE_FOUR</span><span class="p">,</span> <span class="n">STATE_FIVE</span><span class="p">,</span> <span class="n">RECOVERY</span><span class="p">,</span> <span class="n">SUCCESS</span> <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="state-machine-and-multi-core-architecture">State Machine and Multi-Core Architecture
</h2><p>Since the ESP32 we used has a dual-core processor it allowed us to separate the motor control and the actual decision logic onto their own threads. The reason we decided to separate it this way was so that we were able to run the motor operations without any interruptions, have the processing of sensor inputs running and communication with the Java program maintained all at the same time.</p>
<p>This is how the tasks were allocated on the two cores:</p>
<p><strong>Core 0 (Protocol CPU) - Motor Control Tasks</strong>:</p>
<ul>
<li>Bridge motor control task.</li>
<li>Gate motor control task.</li>
<li>Executes commands from the queues.</li>
</ul>
<p><strong>Core 1 (Application CPU) - Decision Logic</strong>:</p>
<ul>
<li>Runs the automatic mode sequences.</li>
<li>Executes commands from the override command queue.</li>
<li>Runs the main loop which includes communication with the Java program.</li>
</ul>
<p>Creating the tasks:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">// Tasks for Multithreading
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">TaskHandle_t</span> <span class="n">AutomaticModeTask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">TaskHandle_t</span> <span class="n">BridgeControlTask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">TaskHandle_t</span> <span class="n">GateControlTask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">TaskHandle_t</span> <span class="n">OverrideQueueTask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Create tasks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">xTaskCreatePinnedToCore</span><span class="p">(</span><span class="n">automaticModeTask</span><span class="p">,</span>   <span class="c1">// Task function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="s">&#34;AutomaticMode&#34;</span><span class="p">,</span>     <span class="c1">// Name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">10000</span><span class="p">,</span>               <span class="c1">// Stack size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nb">NULL</span><span class="p">,</span>                <span class="c1">// Parameter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">2</span><span class="p">,</span>                   <span class="c1">// Priority (higher than motor tasks)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">&amp;</span><span class="n">AutomaticModeTask</span><span class="p">,</span>  <span class="c1">// Task handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">1</span><span class="p">);</span>                  <span class="c1">// Core 1 (Application CPU)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">xTaskCreatePinnedToCore</span><span class="p">(</span><span class="n">bridgeControlTask</span><span class="p">,</span>   <span class="c1">// Task function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="s">&#34;BridgeControl&#34;</span><span class="p">,</span>     <span class="c1">// Name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">4096</span><span class="p">,</span>                <span class="c1">// Stack size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nb">NULL</span><span class="p">,</span>                <span class="c1">// Parameter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">1</span><span class="p">,</span>                   <span class="c1">// Priority
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">&amp;</span><span class="n">BridgeControlTask</span><span class="p">,</span>  <span class="c1">// Task handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">0</span><span class="p">);</span>                  <span class="c1">// Core 0 (Protocol CPU)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">xTaskCreatePinnedToCore</span><span class="p">(</span><span class="n">gateControlTask</span><span class="p">,</span>   <span class="c1">// Task function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="s">&#34;GateControl&#34;</span><span class="p">,</span>     <span class="c1">// Name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">4096</span><span class="p">,</span>              <span class="c1">// Stack size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nb">NULL</span><span class="p">,</span>              <span class="c1">// Parameter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">1</span><span class="p">,</span>                 <span class="c1">// Priority
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">&amp;</span><span class="n">GateControlTask</span><span class="p">,</span>  <span class="c1">// Task handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">0</span><span class="p">);</span>                <span class="c1">// Core 0 (Protocol CPU)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">xTaskCreatePinnedToCore</span><span class="p">(</span><span class="n">overrideQueueTask</span><span class="p">,</span>   <span class="c1">// Task function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="s">&#34;OverrideQueue&#34;</span><span class="p">,</span>     <span class="c1">// Name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">4096</span><span class="p">,</span>                <span class="c1">// Stack size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nb">NULL</span><span class="p">,</span>                <span class="c1">// Parameter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">3</span><span class="p">,</span>                   <span class="c1">// Priority (highest - processes overrides)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">&amp;</span><span class="n">OverrideQueueTask</span><span class="p">,</span>  <span class="c1">// Task handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="mi">1</span><span class="p">);</span>                  <span class="c1">// Core 1 (Application CPU)
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="concurrency-justification">Concurrency Justification
</h3><p>This concurrency was important for a couple of reasons:</p>
<ol>
<li>
<p>The sensor readings were not just for the traffic but also for knowing when to stop rotating the bridge servo. This sounds overkill but actually makes sense.</p>
<ul>
<li>We initially had the bridge servo rotate for 5 seconds (in either direction) for opening and closing. However, we needed the bridge to be precise in terms of where it stopped and this timing method had a lot of variables.</li>
<li>First was that the servo would rotate quicker if there was more power going to it and this was never going to be consistent since we can&rsquo;t control the variance in how much current it draws. Second, this would vary even more as the servo got used more due to wear.</li>
<li>So our solution was to have an ultrasonic sensor on top of the bridge. The motor would stop moving once the bridge was at a certain distance giving a more precise and consistent bridge position every time.</li>
</ul>
</li>
<li>
<p>When we got to the testing phase we discovered that running the motors created electromagnetic interference (EMI) that caused the ultrasonic sensor readings to be invalid (there wouldn&rsquo;t be a reading at all).</p>
<ul>
<li>The reason for this EMI was due to the design of the circuit board (PCB). So the solution expanded on the first point. We were still going to have a distance based bridge movement system instead of a time based one but it would be a stop-measure-restart cycle.</li>
<li>The motor would have to stop in between readings (150ms between the motor moving and the first reading), take 3 readings (average them) and then restart the motor if the target wasn&rsquo;t reached. This sequence needed to run in parallel with the decision logic and network operations.</li>
<li>Because of the cycle approach to the bridge motor movement, the demonstration ended up having a &ldquo;choppy&rdquo; feel. The bridge would open/close through small movements (this included the buzzer noise which we decided should be on when the bridge is moving).</li>
</ul>
</li>
<li>
<p>The emergency stop command needed to halt the motors instantly, regardless of what the decision logic is doing. Since the motor control was on a different core, stopMotor() functions execute without waiting for the state machine or network packets to be processed.</p>
</li>
</ol>
<h3 id="freertos-tasks-and-queues">FreeRTOS Tasks and Queues
</h3><p>For communication between the two cores, we used <strong>FreeRTOS queues</strong>. This allowed both cores to &ldquo;talk&rdquo; to each other without having to directly call upon their functions, meaning that the decision logic could send commands for the motor tasks to consume rather than directly controlling the motors.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">// Command structures
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">OverrideCommand</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">command</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">BridgeCommand</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">BridgeGateState</span> <span class="n">desiredState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">GateCommand</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">BridgeGateState</span> <span class="n">desiredState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Create queues
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">QueueHandle_t</span> <span class="n">bridgeCommandQueue</span> <span class="o">=</span> <span class="n">xQueueCreate</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BridgeCommand</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">QueueHandle_t</span> <span class="n">gateCommandQueue</span> <span class="o">=</span> <span class="n">xQueueCreate</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GateCommand</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">QueueHandle_t</span> <span class="n">pendingOverrideQueue</span> <span class="o">=</span> <span class="n">xQueueCreate</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">OverrideCommand</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So say when the automatic mode task decides the bridge should open since there is boat traffic waiting, it doesn&rsquo;t open the bridge directly, it queues the command instead by calling <code>changeBridgeStateAsync</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">changeBridgeStateAsync</span><span class="p">(</span><span class="n">BridgeGateState</span> <span class="n">desiredMode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Check if enough time has passed since last bridge state change
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastBridgeStateChange</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">currentTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">currentTime</span> <span class="o">-</span> <span class="n">lastBridgeStateChange</span> <span class="o">&lt;</span> <span class="n">BRIDGE_STATE_CHANGE_COOLDOWN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Bridge state change blocked, cooldown period active&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sendUpdate</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE: dequeued_last_message&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">extern</span> <span class="n">BridgeGateState</span> <span class="n">currentBridgeState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">extern</span> <span class="n">QueueHandle_t</span> <span class="n">bridgeCommandQueue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Update the queue if the desired and current states aren&#39;t the same
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">desiredMode</span> <span class="o">!=</span> <span class="n">currentBridgeState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BridgeCommand</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="n">desiredMode</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">xQueueSend</span><span class="p">(</span><span class="n">bridgeCommandQueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The bridge control task (on Core 0) then waits for these commands (in this case opening the bridge) and then executes them. The code snippet below shows how the <code>bridgeControlTask</code> works for opening the bridge. The logic for closing the bridge and weight checks have been removed. I just want to show how the queues are being used and our stop-measure-restart cycle.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">bridgeControlTask</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Command can either be OPEN or CLOSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">BridgeCommand</span> <span class="n">cmd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Runs forever
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// When a command is received (either from automatic mode or override) it wakes up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">xQueueReceive</span><span class="p">(</span><span class="n">bridgeCommandQueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Take mutex before changing state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ... If desired state is CLOSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">desiredState</span> <span class="o">==</span> <span class="n">OPEN</span> <span class="o">&amp;&amp;</span> <span class="n">currentBridgeState</span> <span class="o">!=</span> <span class="n">OPEN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Check weight on bridge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Checking weight on the bridge&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Release for weight check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="kt">long</span> <span class="n">weightReading</span> <span class="o">=</span> <span class="n">checkBridgeWeight</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Send weight reading to Java
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">sendUpdate</span><span class="p">(</span><span class="s">&#34;WEIGHT_CHECK: &#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">weightReading</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Re-acquire lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// ... weight checking logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">          <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Weight check passed (&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">weightReading</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;), opening bridge&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Rotate the motor to open the bridge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">rotateMotorForOpen</span><span class="p">(</span><span class="n">BRIDGE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Release mutex briefly to allow motor to start
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">vTaskDelay</span><span class="p">(</span><span class="mi">200</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Update the timestamp when bridge state change begins
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">lastBridgeStateChange</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Track how long it takes to open the bridge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">operationStartTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Release mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Read how far away the bridge is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="kt">long</span> <span class="n">bridgeDistance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Booleans to keep track of errors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="kt">bool</span> <span class="n">bridgeIsOpen</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="kt">bool</span> <span class="n">timeoutOccurred</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Greater than bridge open distance since bridge is moving closer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// Bridge starts at 15cm (CLOSED), moves to 1cm (OPEN)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">while</span> <span class="p">(</span><span class="n">bridgeDistance</span> <span class="o">&gt;</span> <span class="n">BRIDGE_OPEN_DISTANCE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Timeout protection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">operationStartTime</span> <span class="o">&gt;</span> <span class="n">BRIDGE_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">timeoutOccurred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Stop motor for stable reading (avoid EMI interference)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">stopMotor</span><span class="p">(</span><span class="n">BRIDGE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Wait for motor to fully stop and EMI to settle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">vTaskDelay</span><span class="p">(</span><span class="mi">150</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Take multiple readings and average them to filter out noise/EMI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">long</span> <span class="n">reading1</span><span class="p">,</span> <span class="n">reading2</span><span class="p">,</span> <span class="n">reading3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">bool</span> <span class="n">valid1</span><span class="p">,</span> <span class="n">valid2</span><span class="p">,</span> <span class="n">valid3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Calculate average of valid readings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">validCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">valid1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">sum</span> <span class="o">+=</span> <span class="n">reading1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="n">validCount</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">valid2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">sum</span> <span class="o">+=</span> <span class="n">reading2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="n">validCount</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">valid3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">sum</span> <span class="o">+=</span> <span class="n">reading3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="n">validCount</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">validCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;ERROR: All sensor readings invalid - EMI or sensor failure&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">bridgeDistance</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">/</span> <span class="n">validCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">validCount</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;WARNING: Only &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">validCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;/3 readings valid, using average&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;INFO: Bridge distance (averaged): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">bridgeDistance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34; cm&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Only restart motor if bridge hasn&#39;t reached target
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">bridgeDistance</span> <span class="o">&gt;</span> <span class="n">BRIDGE_OPEN_DISTANCE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">rotateMotorForOpen</span><span class="p">(</span><span class="n">BRIDGE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="c1">// Give motor time to build momentum before next check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="n">vTaskDelay</span><span class="p">(</span><span class="mi">200</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Check if we successfully reached open position
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="n">bridgeDistance</span> <span class="o">&lt;=</span> <span class="n">BRIDGE_OPEN_DISTANCE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">timeoutOccurred</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">bridgeIsOpen</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Stop the motor and update the bridge state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">stopMotor</span><span class="p">(</span><span class="n">BRIDGE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">bridgeIsOpen</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">currentBridgeState</span> <span class="o">=</span> <span class="n">OPEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Bridge is OPEN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">timeoutOccurred</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">currentBridgeState</span> <span class="o">=</span> <span class="n">UNKNOWN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;ERROR: Bridge state UNKNOWN after timeout&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">currentBridgeState</span> <span class="o">=</span> <span class="n">UNKNOWN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;ERROR: Bridge state UNKNOWN due to sensor failure or unknown error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Release mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// If it&#39;s another command then release the mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The same logic is used for the gate task.</p>
<h3 id="mutex-protection">Mutex Protection
</h3><p>While queues are being used to handle the communication between the tasks, shared variables still need to be protected from race conditions. In the code snipped you can see the use of <code>xSemaphoreTake</code> to try and acquire the mutex during the actual bridge movement logic. This mutex acquisition is also being used at the beginning of each task:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">// Mutex declaration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SemaphoreHandle_t</span> <span class="n">stateMutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// In automatic mode task (Core 1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Safe to read/write shared state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">currentOperationalMode</span> <span class="o">==</span> <span class="n">AUTOMATIC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">currentSequenceState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ... The state machine logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// In motor control task (Core 0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">stopMotor</span><span class="p">(</span><span class="n">BRIDGE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Updating a shared variable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">currentBridgeState</span> <span class="o">=</span> <span class="n">OPEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The 100ms timeout in the automatic mode makes sure that no deadlocks happen. If it can&rsquo;t acquire the mutex within 100ms then it&rsquo;ll try again in 500ms. The motor/bridge tasks use <code>portMAX_DELAY</code> since the only run when specifically told to.</p>
<h3 id="automatic-mode-state-machine">Automatic Mode State Machine
</h3><p>The automatic mode task then utilises the bridge and gate tasks as a part of the main core bridge sequencing logic, running every 500ms on Core 1:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">automaticModeTask</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">TickType_t</span> <span class="n">xLastWakeTime</span> <span class="o">=</span> <span class="n">xTaskGetTickCount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">currentOperationalMode</span> <span class="o">==</span> <span class="n">AUTOMATIC</span> <span class="o">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">          <span class="o">!</span><span class="n">isBridgeMovementExecutingInOverride</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">currentSequenceState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="nl">IDLE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Check for traffic and initiate sequences
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">canChangeBridge</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="n">currentBridgeState</span> <span class="o">==</span> <span class="n">CLOSED</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">long</span> <span class="n">boatDistance</span> <span class="o">=</span> <span class="n">readUltrasonicDistanceBoatTraffic</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">isValidSensorReading</span><span class="p">(</span><span class="n">boatDistance</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">boatDistance</span> <span class="o">&lt;</span> <span class="n">BOATS_WAITING_DISTANCE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">currentSequenceState</span> <span class="o">=</span> <span class="n">OPENING_FOR_BOATS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="n">sequenceStartTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="c1">// Check for cars when bridge is open...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="nl">OPENING_FOR_BOATS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Sequence with timing and safety checks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="nl">BOATS_PASSING</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Wait 10 seconds before checking for more traffic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="nl">CLOSING_FOR_CARS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Similar to OPENING_FOR_BOATS but in reverse
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="nl">CARS_PASSING</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Wait 10 seconds before returning to IDLE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="nl">DIAGNOSTIC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Attempt position recovery
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">vTaskDelayUntil</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xLastWakeTime</span><span class="p">,</span> <span class="mi">500</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The 500ms interval was chosen just to ensure that CPU cycles aren&rsquo;t wasted. The <code>vTaskDelayUntil</code> function makes sure that this logic runs at that 500ms interval regardless of how long the logic takes to run. Since the entire logic for the automatic task is too much to fit in this post here&rsquo;s the complete opening sequence with all the timing and safety checks:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">case</span> <span class="nl">OPENING_FOR_BOATS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Execute the sequence for opening the bridge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// currentMovementState is used here to ensure the functions aren&#39;t called again causing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// cooldown blocks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">sequenceStartTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After 2s turn road traffic lights yellow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mi">2000</span> <span class="o">&amp;&amp;</span> <span class="n">currentMovementState</span> <span class="o">==</span> <span class="n">STATE_ONE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// After 2 seconds set the road lights to yellow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">setRoadTrafficLights</span><span class="p">(</span><span class="n">YELLOW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">currentMovementState</span> <span class="o">=</span> <span class="n">STATE_TWO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After 8s set road traffic lights to red and close the gate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mi">8000</span> <span class="o">&amp;&amp;</span> <span class="n">currentMovementState</span> <span class="o">==</span> <span class="n">STATE_TWO</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// After 8 seconds set the road lights to red and close the gates
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">setRoadTrafficLights</span><span class="p">(</span><span class="n">RED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">changeGateStateAsync</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">currentMovementState</span> <span class="o">=</span> <span class="n">STATE_THREE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After 14s open bridge, 6s for gate to close (5s transition + 1s buffer)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mi">14000</span> <span class="o">&amp;&amp;</span> <span class="n">currentMovementState</span> <span class="o">==</span> <span class="n">STATE_THREE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">changeBridgeStateAsync</span><span class="p">(</span><span class="n">OPEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">currentMovementState</span> <span class="o">=</span> <span class="n">STATE_FOUR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After 25s, Check results (14s + 11s for bridge to open and stabilize)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mi">25000</span> <span class="o">&amp;&amp;</span> <span class="n">currentMovementState</span> <span class="o">==</span> <span class="n">STATE_FOUR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Reset movement state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">currentMovementState</span> <span class="o">=</span> <span class="n">STATE_ONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Go into diagnostics mode if the bridge state is unknown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">currentBridgeState</span> <span class="o">==</span> <span class="n">UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentSequenceState</span> <span class="o">=</span> <span class="n">DIAGNOSTIC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Allow up to 13 more seconds for the bridge to fully stop moving
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">currentBridgeState</span> <span class="o">!=</span> <span class="n">OPEN</span> <span class="o">&amp;&amp;</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="mi">38000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentMovementState</span> <span class="o">=</span> <span class="n">STATE_FOUR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// If for some reason the bridge didn&#39;t open then set boat lights to red, open gate and go into RECOVERY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">currentBridgeState</span> <span class="o">!=</span> <span class="n">OPEN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">setBoatTrafficLights</span><span class="p">(</span><span class="n">RED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">changeGateStateAsync</span><span class="p">(</span><span class="n">OPEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentMovementState</span> <span class="o">=</span> <span class="n">RECOVERY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;Info: Bridge state mismatch, expected OPEN, returning to CARS_PASSING&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sendUpdate</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE: bridge_state_mismatch&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Bridge is open, set boat lights to green
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">setBoatTrafficLights</span><span class="p">(</span><span class="n">GREEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">currentMovementState</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After 30s If the bridge is in recovery state (bridge remains closed), set road lights to green and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// go into CARS_PASSING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mi">30000</span> <span class="o">&amp;&amp;</span> <span class="n">currentMovementState</span> <span class="o">==</span> <span class="n">RECOVERY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Ensure gate is open before transitioning to CARS_PASSING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">changeGateStateAsync</span><span class="p">(</span><span class="n">OPEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Release mutex during delay
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Wait 5s for gate to open
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">GATE_TRANSITION_INTERVAL</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">setRoadTrafficLights</span><span class="p">(</span><span class="n">GREEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">currentSequenceState</span> <span class="o">=</span> <span class="n">CARS_PASSING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">currentMovementState</span> <span class="o">=</span> <span class="n">STATE_ONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">sequenceStartTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After 25s if bridge has opened, set boat traffic lights to green and go into BOATS_PASSING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mi">25000</span> <span class="o">&amp;&amp;</span> <span class="n">currentMovementState</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">currentSequenceState</span> <span class="o">=</span> <span class="n">BOATS_PASSING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">currentMovementState</span> <span class="o">=</span> <span class="n">STATE_ONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">sequenceStartTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;Bridge opened: Waiting for boats to pass&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">break</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This sequence based approach turned out to work really well but was hell during testing. Simulating it was one thing, but manually having to figure out what an appropriate amount of time for each state was took forever since a lot of the times checking success states too early causes false failures since the bridge was still moving. The same exact logic but in reverse was used for closing the bridge. The <code>CARS_PASSING</code> and <code>BOATS_PASSING</code> states were essentially just 10 second delays to ensure the traffic had enough time to pass.</p>
<p>The override mode also followed the same logic except rather than the <code>CLOSING_FOR_CARS</code> and <code>OPENING_FOR_BOATS</code> being triggered by the sensor inputs they would be triggered by the commands sent from the Java program. There is also another state in the automatic mode (<code>DIAGNOSTIC</code>) but it&rsquo;s a safety feature so I&rsquo;ll discuss it in this <a class="link" href="#diagnostic-and-recovery-mode" >section</a>.</p>
<h2 id="light-control">Light Control
</h2><p>Another part of this project that was really fun to implement were the traffic and bridge LED lights. These two types of lights had their own purpose. So there were traffic lights for the road traffic (red, yellow and green) and boat traffic (red and green). The bridge lights (only white) were controlled by a photo-resistor. The bridge lights were supposed to act as &ldquo;street lights&rdquo; so when the photo-resistor gets covered (simulating night time), the bridge lights go on.</p>
<p>All these lights were on two shift registers that were daisy chained. The fun part about this was figuring out which bits on the shift corresponded to which lights. We also ran into the issue of the shift register not updating properly. Since there were 16 lights in total, each having their own bit this meant that we would be able to control all the lights using two bytes.</p>
<p>The first thought that comes to mind when wanting to update the lights is to have two separate bytes, update the necessary bits and then shift out the byte for the first shift register then the second byte. This <strong>in theory</strong> should turn on and off lights right, but what ended up happening was that the lights that had their bits set to 1 wouldn&rsquo;t update when you pushed out the 0 bit. So eventually all the lights would just be on. I still don&rsquo;t know why this was the case but the solution that I ended up implementing was to clear out both shift register with zeroed out bytes and then shifting the bytes for the shift registers. There were three different functions to control the lights (two traffic and one bridge). These functions also show which bits on which bytes correspond to which traffic/bridge light:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">// Function to update the lights via shift register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">updateLights</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Set all lights off to avoid the issue with lights not turning off properly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Shift registers don&#39;t seem to dynamically update the lights so 0 them out first
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LATCH_PIN</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">shiftOut</span><span class="p">(</span><span class="n">DATA_PIN</span><span class="p">,</span> <span class="n">CLOCK_PIN</span><span class="p">,</span> <span class="n">MSBFIRST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">shiftOut</span><span class="p">(</span><span class="n">DATA_PIN</span><span class="p">,</span> <span class="n">CLOCK_PIN</span><span class="p">,</span> <span class="n">MSBFIRST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LATCH_PIN</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Start by setting the latch low
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LATCH_PIN</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Shift out the byte to the shift register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">shiftOut</span><span class="p">(</span><span class="n">DATA_PIN</span><span class="p">,</span> <span class="n">CLOCK_PIN</span><span class="p">,</span> <span class="n">MSBFIRST</span><span class="p">,</span> <span class="n">lightStatesRegister2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">shiftOut</span><span class="p">(</span><span class="n">DATA_PIN</span><span class="p">,</span> <span class="n">CLOCK_PIN</span><span class="p">,</span> <span class="n">MSBFIRST</span><span class="p">,</span> <span class="n">lightStatesRegister1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Latch the data to the outputs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LATCH_PIN</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Set road/boat traffic lights
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">setRoadTrafficLights</span><span class="p">(</span><span class="n">LightColours</span> <span class="n">desiredColour</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Clear bits 0, 1, 2 (road traffic light bits)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">lightStatesRegister1</span> <span class="o">=</span> <span class="p">(</span><span class="n">lightStatesRegister1</span> <span class="o">&amp;</span> <span class="mb">0b00011111</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;INFO: Current road traffic light state: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Update tracking variable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">currentRoadTrafficLight</span> <span class="o">=</span> <span class="n">desiredColour</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Set the desired light using |= which is a bitwise OR operator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">switch</span> <span class="p">(</span><span class="n">desiredColour</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">RED</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Bit 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">lightStatesRegister1</span> <span class="o">|=</span> <span class="mb">0b00100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;Red&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">YELLOW</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Bit 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">lightStatesRegister1</span> <span class="o">|=</span> <span class="mb">0b01000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;Yellow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">GREEN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Bit 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">lightStatesRegister1</span> <span class="o">|=</span> <span class="mb">0b10000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;Green&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">NONE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// All off
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">lightStatesRegister1</span> <span class="o">|=</span> <span class="mb">0b00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;None&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">ALL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// All on (Bits 0-2)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">lightStatesRegister1</span> <span class="o">|=</span> <span class="mb">0b11100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;All&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Update shift register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">updateLights</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">setBoatTrafficLights</span><span class="p">(</span><span class="n">LightColours</span> <span class="n">desiredColour</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Clear bits 3 and 4 (boat light bits)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">lightStatesRegister1</span> <span class="o">=</span> <span class="p">(</span><span class="n">lightStatesRegister1</span> <span class="o">&amp;</span> <span class="mb">0b11100111</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;INFO: Current boat traffic light state: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Update tracking variable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">currentBoatTrafficLight</span> <span class="o">=</span> <span class="n">desiredColour</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Set the desired light
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">switch</span> <span class="p">(</span><span class="n">desiredColour</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">RED</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Bit 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">lightStatesRegister1</span> <span class="o">|=</span> <span class="mb">0b00001000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;Red&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">GREEN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Bit 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">lightStatesRegister1</span> <span class="o">|=</span> <span class="mb">0b00010000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;Green&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">NONE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// All off
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">lightStatesRegister1</span> <span class="o">|=</span> <span class="mb">0b00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;None&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">ALL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// All on (Bits 3-4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">lightStatesRegister1</span> <span class="o">|=</span> <span class="mb">0b00011000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;All&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Update shift register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">updateLights</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">setBridgeLights</span><span class="p">(</span><span class="n">BridgeLightState</span> <span class="n">desiredState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">currentBridgeLightState</span> <span class="o">!=</span> <span class="n">desiredState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">currentBridgeLightState</span> <span class="o">=</span> <span class="n">desiredState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">desiredState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">ON</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">lightStatesRegister1</span> <span class="o">|=</span> <span class="mb">0b00000111</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">lightStatesRegister2</span> <span class="o">=</span> <span class="mb">0b11111111</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateLights</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Current bridge light state: on&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">OFF</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">lightStatesRegister1</span> <span class="o">&amp;=</span> <span class="mb">0b11111000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">lightStatesRegister2</span> <span class="o">=</span> <span class="mb">0b00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateLights</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Current bridge light state: off&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="sensor-readings">Sensor Readings
</h2><p>For the sensor readings, we had three different types of values to read in. The first was the distance returned from the ultrasonic sensor, the second was the value (not exactly sure what unit it is) returned from the weight sensor (OP amp) and the third (also don&rsquo;t know the unit) was the value from the photo-resistor.</p>
<p>A cool thing that we discovered when testing was that when two ultrasonic sensors are put into the same pin (on the ESP) and you try to read the value, the closest value is returned. This was pretty useful since in total we had 6 ultrasonic sensors - two on either side of the bridge for boat traffic, two on either side of road traffic, one for determining where the bridge was and one under the bridge to determine if there were boats underneath. So since the closest distance is returned we only had to assign 8 pins (2 each, explained below) in total for the ultrasonic sensors and the traffic logic would still work (if traffic was waiting on one side and not the other the closest distance would tell us that there is traffic).</p>
<p>The way that the readings from these ultrasonics are calculated is also really cool. There are two pins each ultrasonic needs; a <code>Trig</code> and <code>Echo</code> pin. The trig pin sends a short pulse and the echo pin detects this reflected pulse. The ESP then uses this formula to determine the distance:</p>
<p><code>Distance = (Time x Speed of Sound) / 2</code></p>
<p>In terms of code this would look something like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">readUltrasonicDistanceBoatTraffic</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Send a 10-microsecond pulse to the trigPin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">BOAT_TRAFFIC_TRIG_PIN</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">BOAT_TRAFFIC_TRIG_PIN</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">BOAT_TRAFFIC_TRIG_PIN</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Measure the time it takes for the pulse to return on the echoPin - 30ms timeout
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">pulseIn</span><span class="p">(</span><span class="n">BOAT_TRAFFIC_ECHO_PIN</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">,</span> <span class="mi">30000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// If no valid reading, return a large distance (ie no boats)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Boat traffic no sensor connected or invalid reading&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">9999</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Calculate the distance in centimeters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Speed of sound is 0.0343 cm/us
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">long</span> <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="mf">0.0343</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;INFO: Boat traffic distance in cm: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">distance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Return the distance value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">distance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The logic for reading the sensor value for the photo-resistor and OP amp were identical. It was just reading the analog value of the pin using the <code>analogRead</code> function. Since I didn&rsquo;t know what the units of the values being returned were, we just figured out how much weight was &ldquo;too much&rdquo; for the bridge and what value translated to night time from the photo-resistor. In code this looked like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">// Function to read adc values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">long</span> <span class="nf">readAdcSensorValue</span><span class="p">(</span><span class="n">AdcValue</span> <span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">PHOTO_RESISTOR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">PHOTO_RESISTOR_PIN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">BRIDGE_WEIGHT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">BRIDGE_WEIGHT_SENSOR_PIN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="motor-control">Motor Control
</h2><p>This was another part of the bridge system that took a long time to get working properly. Since we were using continuous servos, we discoverd through that the standard Arduino <code>Servo.h</code> library was not giving us control of the servos as intended. The Arduino library was intended for &ldquo;positional&rdquo; servos (meaning that the servos know which angle they are at, 0-180 degrees). On top of this the library can&rsquo;t control the speed/direction. So instead (after a lot of research and trial and error), we used the <code>ledcWrite</code> function. You essentially pass a PWM (with a custom dutyCycle that we had to manually figure out) to rotate the motor. Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">// Rotation for opening --&gt; Can either be BRIDGE or GATE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">rotateMotorForOpen</span><span class="p">(</span><span class="n">Motor</span> <span class="n">motorToMove</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Rotate the motor in one direction (600 microseconds, clockwise)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">dutyCycleCW</span> <span class="o">=</span> <span class="p">(</span><span class="mi">600</span> <span class="o">/</span> <span class="mf">20000.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Rotate according motor, make noise through buzzer and print in console
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">switch</span> <span class="p">(</span><span class="n">motorToMove</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">BRIDGE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Make noise
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">setBuzzer</span><span class="p">(</span><span class="n">SOUND</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Set PWM signal for clockwise direction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ledcWrite</span><span class="p">(</span><span class="n">PWM_CHANNEL_BRIDGE</span><span class="p">,</span> <span class="n">dutyCycleCW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Opening the bridge&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">GATE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Set PWM signal for clockwise direction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ledcWrite</span><span class="p">(</span><span class="n">PWM_CHANNEL_GATE</span><span class="p">,</span> <span class="n">dutyCycleCW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Opening the gate&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Rotation for closing --&gt; Can either be BRIDGE or GATE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">rotateMotorForClose</span><span class="p">(</span><span class="n">Motor</span> <span class="n">motorToMove</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Rotate the motor in the opposite direction (2000 microseconds, counter-clockwise)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">dutyCycleACW</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2000</span> <span class="o">/</span> <span class="mf">20000.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Rotate according motor, make noise through buzzer and print in console
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">switch</span> <span class="p">(</span><span class="n">motorToMove</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">BRIDGE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Make noise
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">setBuzzer</span><span class="p">(</span><span class="n">SOUND</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Set PWM signal for counter-clockwise direction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ledcWrite</span><span class="p">(</span><span class="n">PWM_CHANNEL_BRIDGE</span><span class="p">,</span> <span class="n">dutyCycleACW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Closing the bridge&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">GATE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Set PWM signal for counter-clockwise direction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ledcWrite</span><span class="p">(</span><span class="n">PWM_CHANNEL_GATE</span><span class="p">,</span> <span class="n">dutyCycleACW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Closing the gate&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Stop motor --&gt; Can either be BRIDGE or GATE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">stopMotor</span><span class="p">(</span><span class="n">Motor</span> <span class="n">motorToMove</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Stop the motor (1500 microseconds, neutral)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">dutyCycleStop</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1500</span> <span class="o">/</span> <span class="mf">20000.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">motorToMove</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">BRIDGE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">setBuzzer</span><span class="p">(</span><span class="n">NO_SOUND</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">ledcWrite</span><span class="p">(</span><span class="n">BUZZER_CHANNEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Set PWM signal for stop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ledcWrite</span><span class="p">(</span><span class="n">PWM_CHANNEL_BRIDGE</span><span class="p">,</span> <span class="n">dutyCycleStop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Stopping the bridge motor&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">GATE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Set PWM signal for stop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ledcWrite</span><span class="p">(</span><span class="n">PWM_CHANNEL_GATE</span><span class="p">,</span> <span class="n">dutyCycleStop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Stopping the gate motor&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>That wraps up all the main parts that control the ESP32 and its peripherals. The next two sections are just going to be about how the ESP talks to the Java program and all the safety features (that I found interesting) we implemented.</p>
<h2 id="communication-with-java-program">Communication with Java Program
</h2><p>The ESP32 communicates with the Java program using UDP over WiFi. For our demonstration and testing purposes we used a hotspot with credentials that were okay to have in the Git repo (not going to find any important creds so don&rsquo;t bother).</p>
<p>There were a couple of things which were tedious with this though:</p>
<ul>
<li>Hotspots have DHCP enabled and can&rsquo;t be disabled. So this meant that every time we took a break from testing or came back to class the following week I&rsquo;d have to figure out and update the IP address of the ESP32 in the Java program and vice versa.</li>
<li>Another minor annoying thing was that the Windows Defender Firewall (needed to be turned off) blocked the communication being sent by the ESP32 but was okay with the packets being sent to the ESP32. The first few times I&rsquo;d just sit there and look through the commit history wondering why everything magically stopped working.</li>
</ul>
<p>The communication protocol that we came up with uses simple string messages with two dedicated ports (randomly selected them):</p>
<ul>
<li><strong>Port 3031</strong>: ESP32 listens on this port for messages from the Java program.</li>
<li><strong>Port 3032</strong>: Java listens on this port for messages from the ESP32.</li>
</ul>
<p>For the ESP32 side this was implemented using the <code>WiFi.h</code> and <code>WifiUDP.h</code> libraries.</p>
<h3 id="message-types">Message Types
</h3><p>The messages sent between the two programs can be categorised into four different types:</p>
<h4 id="status-updates-esp32----java">Status Updates (ESP32 &ndash;&gt; Java)
</h4><p>The status updates are the messages sent <strong>every second</strong> and they include all the necessary system information in a pipe-delimited format:</p>
<blockquote>
<p>STATUS: MODE:AUTOMATIC|BRIDGE:CLOSED|GATE:OPEN|ROAD_DISTANCE:27|
BOAT_DISTANCE:27|BRIDGE_MOVEMENT_DISTANCE:1|BOAT_CLEARANCE_DISTANCE:30|
ROAD_LIGHT:GREEN|BOAT_LIGHT:RED|BRIDGE_LIGHT:OFF|MANUAL_BRIDGE_LIGHTS:NO|
SEQUENCE:IDLE|MOVEMENT_STATE:STATE_ONE</p>
</blockquote>
<p>Last year we had a similar project (had to make a train carriage) and the message format decided was JSON. But this was overkill (imo) and required a bunch of extra dependencies for the ESP23 and Java program so this time around we just decided to have the string with key-value pairs.</p>
<p>There are also a couple of additional fields in override mode that get included to this status update:</p>
<blockquote>
<p>STATUS: MODE:OVERRIDE|&hellip;|QUEUE:2|EXECUTING:YES</p>
</blockquote>
<p>This is the entire <code>communication.cpp</code> file, showing the status update message format and how the WiFi libraries are used:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;communication/communication.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;config/config.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;sensors/sensors.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;types/types.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// External global variables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="n">WiFiUDP</span> <span class="n">udp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">OperationalMode</span> <span class="n">currentOperationalMode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">BridgeGateState</span> <span class="n">currentBridgeState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">BridgeGateState</span> <span class="n">currentGateState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">BridgeSequenceState</span> <span class="n">currentSequenceState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">BridgeMovementState</span> <span class="n">currentMovementState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">LightColours</span> <span class="n">currentRoadTrafficLight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">LightColours</span> <span class="n">currentBoatTrafficLight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">BridgeLightState</span> <span class="n">currentBridgeLightState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">totalBridgeOpenings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">totalBridgeClosings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">faultCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">systemStartTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">bool</span> <span class="n">isBridgeMovementExecutingInOverride</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">bool</span> <span class="n">manualBridgeLights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">QueueHandle_t</span> <span class="n">pendingOverrideQueue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">SemaphoreHandle_t</span> <span class="n">stateMutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Communication Function */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Function to send updates via UDP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">sendUpdate</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Sending message to Java Program: &#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">udp</span><span class="p">.</span><span class="n">beginPacket</span><span class="p">(</span><span class="n">remoteIP</span><span class="p">,</span> <span class="n">remotePort</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">udp</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">udp</span><span class="p">.</span><span class="n">endPacket</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Status update function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">sendStatusUpdate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Acquire mutex (runs on main loop meaning the default Core 1 Application CPU)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="mi">50</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Read current distances
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">long</span> <span class="n">roadDistance</span> <span class="o">=</span> <span class="n">readUltrasonicDistanceRoadTraffic</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">boatDistance</span> <span class="o">=</span> <span class="n">readUltrasonicDistanceBoatTraffic</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">bridgeMovementDistance</span> <span class="o">=</span> <span class="n">readUltrasonicDistanceBridgeMovement</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">boatClearanceDistance</span> <span class="o">=</span> <span class="n">readUltrasonicDistanceBoatClearance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Create the status message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">statusMsg</span> <span class="o">=</span> <span class="s">&#34;STATUS: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;MODE:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">operationalModeToString</span><span class="p">(</span><span class="n">currentOperationalMode</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;BRIDGE:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">bridgeGateStateToString</span><span class="p">(</span><span class="n">currentBridgeState</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;GATE:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">bridgeGateStateToString</span><span class="p">(</span><span class="n">currentGateState</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;ROAD_DISTANCE:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">roadDistance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;BOAT_DISTANCE:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">boatDistance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;BRIDGE_MOVEMENT_DISTANCE:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">bridgeMovementDistance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;BOAT_CLEARANCE_DISTANCE:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">boatClearanceDistance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;ROAD_LIGHT:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">lightColourToString</span><span class="p">(</span><span class="n">currentRoadTrafficLight</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;BOAT_LIGHT:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">lightColourToString</span><span class="p">(</span><span class="n">currentBoatTrafficLight</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;BRIDGE_LIGHT:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">bridgeLightStateToString</span><span class="p">(</span><span class="n">currentBridgeLightState</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;MANUAL_BRIDGE_LIGHTS:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">manualBridgeLights</span> <span class="o">?</span> <span class="s">&#34;YES&#34;</span> <span class="o">:</span> <span class="s">&#34;NO&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;SEQUENCE:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">sequenceStateToString</span><span class="p">(</span><span class="n">currentSequenceState</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#34;|&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;MOVEMENT_STATE:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">movementStateToString</span><span class="p">(</span><span class="n">currentMovementState</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Add queue info if in override mode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">currentOperationalMode</span> <span class="o">==</span> <span class="n">OVERRIDE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">UBaseType_t</span> <span class="n">queuedCommands</span> <span class="o">=</span> <span class="n">uxQueueMessagesWaiting</span><span class="p">(</span><span class="n">pendingOverrideQueue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;|QUEUE:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">queuedCommands</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s">&#34;|EXECUTING:&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">isBridgeMovementExecutingInOverride</span> <span class="o">?</span> <span class="s">&#34;YES&#34;</span> <span class="o">:</span> <span class="s">&#34;NO&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Send the status update and release the mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sendUpdate</span><span class="p">(</span><span class="n">statusMsg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The Java program then parses these status messages by splitting the strings based on the pipe and getting the key-value pairs:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleStatusUpdate</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">).</span><span class="na">trim</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;\\|&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">parts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">keyValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">part</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keyValue</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyValue</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">.</span><span class="na">trim</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyValue</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">.</span><span class="na">trim</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;MODE&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">userInterface</span><span class="p">.</span><span class="na">updateMode</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;BRIDGE&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">userInterface</span><span class="p">.</span><span class="na">updateBridgeState</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ... Etc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="event-messages-esp32----java">Event Messages (ESP32 &ndash;&gt; Java)
</h4><p>The next type of messages that are sent are event messages whenever something &ldquo;important&rdquo; happens on the ESP32 side. This triggers notifications on the Java GUI. The following tables summarise these events:</p>
<p><strong>System Events:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Message</th>
          <th>Trigger</th>
          <th>Java Action</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>SYSTEM_UPDATE: communication_connected</code></td>
          <td>First heartbeat received</td>
          <td>Show &ldquo;Connected&rdquo; notification</td>
      </tr>
      <tr>
          <td><code>SYSTEM_UPDATE: communication_lost</code></td>
          <td>Heartbeat timeout after 5s</td>
          <td>Show &ldquo;Connection Lost&rdquo; notification</td>
      </tr>
      <tr>
          <td><code>SYSTEM_UPDATE: diagnostic_mode</code></td>
          <td>Unknown bridge position</td>
          <td>Show &ldquo;Diagnostic Mode&rdquo; notification</td>
      </tr>
      <tr>
          <td><code>SYSTEM_UPDATE: restart_required</code></td>
          <td>Some error can&rsquo;t recover from</td>
          <td>Show &ldquo;Restart Required&rdquo; notification</td>
      </tr>
      <tr>
          <td><code>SYSTEM_UPDATE: recovered</code></td>
          <td>Diagnostic recovery successful</td>
          <td>Show &ldquo;Bridge Recovered&rdquo; notification</td>
      </tr>
  </tbody>
</table></div>
<p><strong>Mode Changes:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Message</th>
          <th>Trigger</th>
          <th>Java Action</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>MODE_CHANGE: override_mode_active</code></td>
          <td>Switched to override mode</td>
          <td>Disable all the manual control buttons</td>
      </tr>
      <tr>
          <td><code>MODE_CHANGE: automatic_mode_active</code></td>
          <td>Switched to automatic mode</td>
          <td>Disable all the manual control buttons</td>
      </tr>
      <tr>
          <td><code>MODE_CHANGE: mode_change_completed</code></td>
          <td>Queued mode change executed</td>
          <td>Show &ldquo;Mode Changed&rdquo; notification</td>
      </tr>
  </tbody>
</table></div>
<p><strong>Errors:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Message</th>
          <th>Trigger</th>
          <th>Java Action</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>ERROR: override_denied_traffic_present</code></td>
          <td>Override requested with traffic detected</td>
          <td>Show error dialog</td>
      </tr>
      <tr>
          <td><code>ERROR: bridge_unknown_state</code></td>
          <td>Bridge position cannot be determined</td>
          <td>Show diagnostic mode notification</td>
      </tr>
      <tr>
          <td><code>ERROR: mode_change_timeout</code></td>
          <td>Mode change queued for more than 60s</td>
          <td>Show a timeout error</td>
      </tr>
      <tr>
          <td><code>ERROR: bridge_closing_failed</code></td>
          <td>Bridge open close properly</td>
          <td>Show recovery notification</td>
      </tr>
      <tr>
          <td><code>ERROR: bridge_opening_failed</code></td>
          <td>Bridge didn&rsquo;t open properly</td>
          <td>Show recovery notification</td>
      </tr>
  </tbody>
</table></div>
<p><strong>Warnings:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Message</th>
          <th>Trigger</th>
          <th>Java Action</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>WARNING: command_queue_full|SIZE:3</code></td>
          <td>Override queue at max capacity</td>
          <td>Show &ldquo;Queue Full&rdquo; warning</td>
      </tr>
      <tr>
          <td><code>WARNING: command_ignored_wrong_mode</code></td>
          <td>Override command sent in automatic mode</td>
          <td>Log warning message</td>
      </tr>
  </tbody>
</table></div>
<p><strong>Emergency Stop:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Message</th>
          <th>Trigger</th>
          <th>Java Action</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>EMERGENCY_STOP: activated|MODE:override|STATE:diagnostic</code></td>
          <td>Emergency stop triggered</td>
          <td>Flash red warning and show all lights active</td>
      </tr>
  </tbody>
</table></div>
<h4 id="commands-java----esp32">Commands (Java &ndash;&gt; ESP32)
</h4><p>The commands sent from the Java program to the ESP32 are also simple string messages. The ESP32 processes these in the main <code>loop()</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cm">/* The main loop */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Listen for incoming UDP packets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">packetSize</span> <span class="o">=</span> <span class="n">udp</span><span class="p">.</span><span class="n">parsePacket</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// If there is a packet then accordingly process the command
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">packetSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Buffer to hold incoming packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Set all bytes at the buffer in memory to 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">memset</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Read the packet into the buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">bytesRead</span> <span class="o">=</span> <span class="n">udp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span> <span class="n">packetSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Null-terminate at the exact length received
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">packetBuffer</span><span class="p">[</span><span class="n">bytesRead</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Convert buffer to string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Remove any extra whitespace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cmd</span><span class="p">.</span><span class="n">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Remove null characters if they exist
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cmd</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">indexOf</span><span class="p">(</span><span class="mh">0x00</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="p">.</span><span class="n">length</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">126</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Remove non-printable character
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">cmd</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Adjust index after removal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">i</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Command received: &#34;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... Rest of the message received logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// ... Rest of the main loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>These tables summarise the commands sent by the Java program:</p>
<p><strong>Mode Control:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Command</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>automatic_mode</code></td>
          <td>Switch to automatic mode</td>
      </tr>
      <tr>
          <td><code>override_mode</code></td>
          <td>Switch to override mode</td>
      </tr>
      <tr>
          <td><code>heartbeat</code></td>
          <td>Keep-alive signal</td>
      </tr>
  </tbody>
</table></div>
<p><strong>Emergency and Safety:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Command</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>emergency_stop</code></td>
          <td>Stop everything immediately</td>
      </tr>
      <tr>
          <td><code>silence_alarm</code></td>
          <td>Turn off buzzer</td>
      </tr>
      <tr>
          <td><code>perform_diagnostics</code></td>
          <td>Try bridge state recovery</td>
      </tr>
      <tr>
          <td><code>restart</code></td>
          <td>Restart ESP32</td>
      </tr>
  </tbody>
</table></div>
<p><strong>Override Mode Sequence Commands:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Command</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>allow_boat_traffic</code></td>
          <td>Execute bridge opening sequence</td>
      </tr>
      <tr>
          <td><code>allow_road_traffic</code></td>
          <td>Execute bridge closing sequence</td>
      </tr>
      <tr>
          <td><code>run_full_test</code></td>
          <td>Test all states and transitions</td>
      </tr>
  </tbody>
</table></div>
<p><strong>Override Mode Commands:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Command</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>open_bridge</code></td>
          <td>Open bridge (no traffic light coordination)</td>
      </tr>
      <tr>
          <td><code>close_bridge</code></td>
          <td>Close bridge (no traffic light coordination)</td>
      </tr>
      <tr>
          <td><code>open_gate</code></td>
          <td>Open boom gate</td>
      </tr>
      <tr>
          <td><code>close_gate</code></td>
          <td>Close boom gate</td>
      </tr>
  </tbody>
</table></div>
<p><strong>Override Mode Light Control Commands:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Command</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>road_lights_red</code></td>
          <td>Set road lights to red</td>
      </tr>
      <tr>
          <td><code>road_lights_yellow</code></td>
          <td>Set road lights to yellow</td>
      </tr>
      <tr>
          <td><code>road_lights_green</code></td>
          <td>Set road lights to green</td>
      </tr>
      <tr>
          <td><code>road_lights_all</code></td>
          <td>Turn on all road lights</td>
      </tr>
      <tr>
          <td><code>boat_lights_red</code></td>
          <td>Set boat lights to red</td>
      </tr>
      <tr>
          <td><code>boat_lights_green</code></td>
          <td>Set boat lights to green</td>
      </tr>
      <tr>
          <td><code>boat_lights_all</code></td>
          <td>Turn on all boat lights</td>
      </tr>
      <tr>
          <td><code>bridge_lights_on</code></td>
          <td>Turn on bridge deck lights</td>
      </tr>
      <tr>
          <td><code>bridge_lights_off</code></td>
          <td>Turn off bridge deck lights</td>
      </tr>
  </tbody>
</table></div>
<h4 id="heartbeat-java----esp32">Heartbeat (Java &ndash;&gt; ESP32)
</h4><p>The last message type is the heartbeat message sent from the Java program to the ESP32. The purpose of this is more important in when the bridge is in <code>override</code> mode. Essentially the bridge will go in <code>automatic</code> mode (if it isn&rsquo;t already) if the ESP32 received the last heartbeat message more than 5 seconds ago. In the case that the Java program crashes this makes sure that the bridge is able to continue operating and doesn&rsquo;t stay stuck in <code>override</code>.</p>
<p>On the Java side:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Heartbeat</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">heartBeatSendObject</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Timer</span><span class="w"> </span><span class="n">heartBeatTimer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Gui</span><span class="w"> </span><span class="n">userInterface</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Heartbeat interval in milliseconds (2 seconds)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">HEARTBEAT_INTERVAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">2000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Initial delay before first heartbeat (1 second)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">INITIAL_DELAY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Heartbeat</span><span class="p">(</span><span class="n">Send</span><span class="w"> </span><span class="n">heartbeatObject</span><span class="p">,</span><span class="w"> </span><span class="n">Gui</span><span class="w"> </span><span class="n">userInterface</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">heartBeatSendObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heartbeatObject</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">userInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userInterface</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Make it a daemon thread</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">heartBeatTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Timer</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// scheduleAtFixedRate for repeating task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">heartBeatTimer</span><span class="p">.</span><span class="na">scheduleAtFixedRate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TimerTask</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">heartBeatSendObject</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="s">&#34;heartbeat&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userInterface</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">userInterface</span><span class="p">.</span><span class="na">updateMessageLog</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="s">&#34;SENT: heartbeat&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Error sending heartbeat: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="n">INITIAL_DELAY</span><span class="p">,</span><span class="w"> </span><span class="n">HEARTBEAT_INTERVAL</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stopHeartbeat</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">heartBeatTimer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">heartBeatTimer</span><span class="p">.</span><span class="na">cancel</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Heartbeat stopped&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>And on the ESP32 side in the main loop:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">// Check heartbeat timeout
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Check communication with Java program has been lost
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">heartbeatTimedOut</span> <span class="o">=</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">lastHeartbeatMessage</span> <span class="o">&gt;</span> <span class="n">HEARTBEAT_INTERVAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Communication just got lost
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">heartbeatTimedOut</span> <span class="o">&amp;&amp;</span> <span class="n">communicationWithJavaIsAlive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">communicationWithJavaIsAlive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE: Lost communication with Java program&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">currentOperationalMode</span> <span class="o">==</span> <span class="n">OVERRIDE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Clear override queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">cleared</span> <span class="o">=</span> <span class="n">clearOverrideQueue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">cleared</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;INFO: Cleared &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">cleared</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34; queued override commands&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">currentOperationalMode</span> <span class="o">=</span> <span class="n">AUTOMATIC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Only reset state if not currently executing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isBridgeMovementExecutingInOverride</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">currentSequenceState</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">currentMovementState</span> <span class="o">=</span> <span class="n">STATE_ONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE: Reset to IDLE state (no execution in progress)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Check if execution has been going too long
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">executionTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">overrideExecutionStartTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">OVERRIDE_EXECUTION_TIMEOUT</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">;</span>  <span class="c1">// 60 seconds
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">executionTime</span> <span class="o">&gt;</span> <span class="n">OVERRIDE_EXECUTION_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;ERROR: Override execution timeout - forcing DIAGNOSTIC&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">currentSequenceState</span> <span class="o">=</span> <span class="n">DIAGNOSTIC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">isBridgeMovementExecutingInOverride</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">setRoadTrafficLights</span><span class="p">(</span><span class="n">ALL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">setBoatTrafficLights</span><span class="p">(</span><span class="n">ALL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;INFO: Allowing operation to complete (&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">((</span><span class="n">OVERRIDE_EXECUTION_TIMEOUT</span> <span class="o">-</span> <span class="n">executionTime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;s timeout remaining, state: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">sequenceStateToString</span><span class="p">(</span><span class="n">currentSequenceState</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">manualBridgeLights</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Cancel any pending mode changes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pendingModeChange</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE: Switched to automatic mode due to communication loss&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sendUpdate</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE: communication_lost&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="safety-features">Safety Features
</h2><p>This section goes over all the extra features and cool stuff we added for more marks that I thought were worthy of being in this post.</p>
<h3 id="weight-monitoring">Weight Monitoring
</h3><p>So as talked about before, we used an OP amp to determine the weight on the bridge. We used this value to determine whether or not the bridge opening sequence should go ahead (if the weight exceeds 2160, found through manual testing, then that means there is something on the bridge so don&rsquo;t open it). If the bridge did have weight on it then it would just go back into the <code>CARS_PASSING</code> mode (10 second wait again) and open the gates to allow the bridge to clear. Function for this weight check:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">// Check for what the weight is on the bridge through OP Amp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">long</span> <span class="nf">checkBridgeWeight</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;INFO: Performing bridge weight check&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Rotate the motor in one direction (600 microseconds, clockwise) briefly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">dutyCycleCW</span> <span class="o">=</span> <span class="p">(</span><span class="mi">600</span> <span class="o">/</span> <span class="mf">20000.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ledcWrite</span><span class="p">(</span><span class="n">PWM_CHANNEL_BRIDGE</span><span class="p">,</span> <span class="n">dutyCycleCW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Wait for current to stabilise
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">delay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Read the current draw (proportional to weight)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">long</span> <span class="n">weightReading</span> <span class="o">=</span> <span class="n">readAdcSensorValue</span><span class="p">(</span><span class="n">BRIDGE_WEIGHT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">delay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">weightReading2</span> <span class="o">=</span> <span class="n">readAdcSensorValue</span><span class="p">(</span><span class="n">BRIDGE_WEIGHT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">delay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">weightReading3</span> <span class="o">=</span> <span class="n">readAdcSensorValue</span><span class="p">(</span><span class="n">BRIDGE_WEIGHT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Get the average
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">long</span> <span class="n">averageWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">weightReading</span> <span class="o">+</span> <span class="n">weightReading2</span> <span class="o">+</span> <span class="n">weightReading3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Stop motor immediately
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">dutyCycleStop</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1500</span> <span class="o">/</span> <span class="mf">20000.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ledcWrite</span><span class="p">(</span><span class="n">PWM_CHANNEL_BRIDGE</span><span class="p">,</span> <span class="n">dutyCycleStop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;INFO: Weight check ADC reading is: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">averageWeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">averageWeight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And this is how <code>checkBridgeWeight</code> was actually used in the bridge task:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">weightReading</span> <span class="o">=</span> <span class="n">checkBridgeWeight</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Send weight reading to Java
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">sendUpdate</span><span class="p">(</span><span class="s">&#34;WEIGHT_CHECK: &#34;</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">weightReading</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Re-acquire lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">weightReading</span> <span class="o">&gt;</span> <span class="n">WEIGHT_SAFETY_MARGIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;INFO: Weight on bridge is overloaded, re-closing bridge: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">weightReading</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">dutyCycleACW</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2000</span> <span class="o">/</span> <span class="mf">20000.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ledcWrite</span><span class="p">(</span><span class="n">PWM_CHANNEL_BRIDGE</span><span class="p">,</span> <span class="n">dutyCycleACW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Ensure return to close
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">delay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">dutyCycleStop</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1500</span> <span class="o">/</span> <span class="mf">20000.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ledcWrite</span><span class="p">(</span><span class="n">PWM_CHANNEL_BRIDGE</span><span class="p">,</span> <span class="n">dutyCycleStop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">sendUpdate</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE: bridge_overloaded&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">currentBridgeState</span> <span class="o">=</span> <span class="n">CLOSED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">stateMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Don&#39;t proceed with opening
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="boat-clearance-detection">Boat Clearance Detection
</h3><p>Another feature that we added was having an ultrasonic sensor under the bridge. The purpose of this was to stop the bridge from closing in the case that a boat decided to run a red light. We configured this value to be anything less than 15cm since the water was 15cm away when the bridge is fully closed. The implementation for this function was the same as the other ultrasonic sensors and this was how it got used in the bridge task:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">BRIDGE_BOAT_DETECTED_WHILE_MOVING</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">bridgeDistance</span> <span class="o">&lt;</span> <span class="n">BRIDGE_CLOSED_DISTANCE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Timeout check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">operationStartTime</span> <span class="o">&gt;</span> <span class="n">BRIDGE_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeoutOccurred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Clearance check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">long</span> <span class="n">distanceUnderBridge</span> <span class="o">=</span> <span class="n">readUltrasonicDistanceBoatClearance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">isValidSensorReading</span><span class="p">(</span><span class="n">distanceUnderBridge</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">      <span class="n">distanceUnderBridge</span> <span class="o">&lt;</span> <span class="n">BRIDGE_BOAT_DETECTED_WHILE_MOVING</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;ERROR: Detected boat while closing bridge&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">boatsDetectedDuringClosing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Stop moving the bridge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// ... Rest of the close bridge logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// After the loop handle the boat detection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">boatsDetectedDuringClosing</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">currentBridgeState</span> <span class="o">=</span> <span class="n">OPEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="traffic-detection-before-mode-switching">Traffic Detection Before Mode Switching
</h3><p>The ESP32 won&rsquo;t switch into <code>override</code> mode if traffic is present (to match the use case of override mode):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&#34;override_mode&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Move to override
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Mutex already held at this point so read the sensor values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">long</span> <span class="n">roadDistance</span> <span class="o">=</span> <span class="n">readUltrasonicDistanceRoadTraffic</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">boatDistance</span> <span class="o">=</span> <span class="n">readUltrasonicDistanceBoatTraffic</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">roadTrafficDetected</span> <span class="o">=</span> <span class="n">isValidSensorReading</span><span class="p">(</span><span class="n">roadDistance</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">roadDistance</span> <span class="o">&lt;</span> <span class="n">CARS_WAITING_DISTANCE</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">boatTrafficDetected</span> <span class="o">=</span> <span class="n">isValidSensorReading</span><span class="p">(</span><span class="n">boatDistance</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">boatDistance</span> <span class="o">&lt;</span> <span class="n">BOATS_WAITING_DISTANCE</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">roadTrafficDetected</span> <span class="o">||</span> <span class="n">boatTrafficDetected</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;ERROR: Override mode denied - traffic present&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sendUpdate</span><span class="p">(</span><span class="s">&#34;ERROR: override_denied_traffic_present&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Don&#39;t queue the request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">pendingModeChange</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ,, Rest of the override mode command logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mode-change-queuing">Mode Change Queuing
</h3><p>The mode changes are also queued (just like the bridge/gate tasks). This is done so that mode changes only occur when the bridge isn&rsquo;t moving:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">isSafeToSwitchMode</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">((</span><span class="n">currentSequenceState</span> <span class="o">==</span> <span class="n">IDLE</span> <span class="o">||</span> 
</span></span><span class="line"><span class="cl">           <span class="n">currentSequenceState</span> <span class="o">==</span> <span class="n">BOATS_PASSING</span> <span class="o">||</span> 
</span></span><span class="line"><span class="cl">           <span class="n">currentSequenceState</span> <span class="o">==</span> <span class="n">CARS_PASSING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="o">!</span><span class="n">isBridgeMovementExecutingInOverride</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// In main loop:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">pendingModeChange</span><span class="p">.</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">pendingModeChange</span><span class="p">.</span><span class="n">requestTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">isSafeToSwitchMode</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Execute the queued mode change
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">currentOperationalMode</span> <span class="o">=</span> <span class="n">pendingModeChange</span><span class="p">.</span><span class="n">requestedMode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">currentSequenceState</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">clearOverrideQueue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">pendingModeChange</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;</span> <span class="mi">60000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Timeout after 60 seconds
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;ERROR: Mode change request timed out&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pendingModeChange</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="diagnostic-and-recovery-mode">Diagnostic and Recovery Mode
</h3><p>This one was really fun. When the bridge is in an <code>UNNNOWN</code> state it first tries to determine where the bridge (using the ultrasonic sensor on top of the bridge) is before going into a state where manual reset is required:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">case</span> <span class="nl">DIAGNOSTIC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE: System is in DIAGNOSTIC mode&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">setRoadTrafficLights</span><span class="p">(</span><span class="n">ALL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">setBoatTrafficLights</span><span class="p">(</span><span class="n">ALL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">bridgeDistance</span> <span class="o">=</span> <span class="n">readUltrasonicDistanceBridgeMovement</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">isValidSensorReading</span><span class="p">(</span><span class="n">bridgeDistance</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Double tolerance for recovery (4cm instead of 2cm)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">bridgeDistance</span> <span class="o">-</span> <span class="n">BRIDGE_OPEN_DISTANCE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TOLERANCE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Bridge appears open
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">currentBridgeState</span> <span class="o">=</span> <span class="n">OPEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">currentSequenceState</span> <span class="o">=</span> <span class="n">BOATS_PASSING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">changeGateStateAsync</span><span class="p">(</span><span class="n">CLOSED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">GATE_TRANSITION_INTERVAL</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">setBoatTrafficLights</span><span class="p">(</span><span class="n">GREEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">setRoadTrafficLights</span><span class="p">(</span><span class="n">RED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sequenceStartTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE: Recovered, bridge is OPEN&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">bridgeDistance</span> <span class="o">-</span> <span class="n">BRIDGE_CLOSED_DISTANCE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TOLERANCE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Bridge appears closed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">currentBridgeState</span> <span class="o">=</span> <span class="n">CLOSED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">currentSequenceState</span> <span class="o">=</span> <span class="n">CARS_PASSING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">changeGateStateAsync</span><span class="p">(</span><span class="n">OPEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">GATE_TRANSITION_INTERVAL</span> <span class="o">/</span> <span class="n">portTICK_PERIOD_MS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">setBoatTrafficLights</span><span class="p">(</span><span class="n">RED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">setRoadTrafficLights</span><span class="p">(</span><span class="n">GREEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE: Recovered, bridge is CLOSED&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Unable to recover
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&#34;ERROR: Bridge position unknown, restart required&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">restartRequired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">break</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="timeout-protection">Timeout Protection
</h3><p>All the motor operations are capped to 30 seconds and after that they are timed out (prevent infinite loops):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BRIDGE_TIMEOUT</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">bridgeDistance</span> <span class="o">&gt;</span> <span class="n">BRIDGE_OPEN_DISTANCE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">operationStartTime</span> <span class="o">&gt;</span> <span class="n">BRIDGE_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeoutOccurred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ... movement logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">timeoutOccurred</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Triggers diagnostic mode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">currentBridgeState</span> <span class="o">=</span> <span class="n">UNKNOWN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="testing-sequence">Testing Sequence
</h3><p>In override mode there is a full testing sequence that the operator can trigger. The code for that is too large to put here but it essentially checks all the parts of the system:</p>
<ul>
<li>Open/close the bridge and gate.</li>
<li>Turn on/off all the lights.</li>
<li>Turn on/off the buzzer.</li>
<li>Test communication with the GUI.</li>
</ul>
<h2 id="final-look-of-the-esp32-and-bridge">Final Look of the ESP32 and Bridge
</h2><p>After all that reading, here&rsquo;s what the final bridge ended up looking like (all the circuitry was on top of the bridge):</p>
<p><img src="/p/engg3000-vertical-lift-bridge/images/box.jpg"
	width="4624"
	height="2084"
	srcset="/p/engg3000-vertical-lift-bridge/images/box_hu16656848451417853057.jpg 480w, /p/engg3000-vertical-lift-bridge/images/box_hu15261184453042139119.jpg 1024w"
	loading="lazy"
	
		alt="That box is a bridge?"
	
	
		class="gallery-image" 
		data-flex-grow="221"
		data-flex-basis="532px"
	
></p>
<p><img src="/p/engg3000-vertical-lift-bridge/images/scary.jpg"
	width="4032"
	height="3024"
	srcset="/p/engg3000-vertical-lift-bridge/images/scary_hu13356738656483331824.jpg 480w, /p/engg3000-vertical-lift-bridge/images/scary_hu1211691228003654468.jpg 1024w"
	loading="lazy"
	
		alt="Scary circuit stuff"
	
	
		class="gallery-image" 
		data-flex-grow="133"
		data-flex-basis="320px"
	
></p>
<p>And here is the bridge looked like in automatic mode. Note that the gate wasn&rsquo;t working as the gate motor wasn&rsquo;t able to get enough power (you can hear it struggling):</p>
<div class="video-wrapper">
    <video
    controls
    src="videos/automatic_mode.mp4"
    
    
    >
        <p>
            Your browser doesn't support HTML5 video. Here is a
            <a href="videos/automatic_mode.mp4">link to the video</a> instead.
        </p>
    </video>
</div>

<h1 id="java-program">Java Program
</h1><h2 id="overview">Overview
</h2><p>Onto the last part of this project, the actual Java program (built using Gradle). It&rsquo;s much simpler than the ESP32 program. The main functions of this program include monitoring and controlling:</p>
<ul>
<li>The current operational mode.</li>
<li>Bridge and gate positions.</li>
<li>Light states (traffic and bridge).</li>
<li>All the current sensor readings.</li>
<li>The sequence and movement states.</li>
<li>The queue size in override mode.</li>
<li>Message log with timestamps.</li>
<li>Notifications for important events.</li>
<li>Panel for connection status.</li>
</ul>
<p>The architecture for this one is pretty simple. There&rsquo;s a GUI class that handles the display and user input, and then there&rsquo;s 3 separate threads to manage the network communications.</p>
<h2 id="multithreading">Multithreading
</h2><p>So the three threads to keep the GUI responsive whilst handling the network communication include:</p>
<p><strong>Main Thread (GUI)</strong>:</p>
<ul>
<li>This handles all the Swing GUI parts and user interactions.</li>
<li>Updates all the displays based on messages from the receive thread.</li>
<li>Processes the button clicks and sends commands through a send object.</li>
</ul>
<p><strong>Receive Thread</strong>:</p>
<ul>
<li>This continuously listens for packets from the ESP32.</li>
<li>It parse all the incoming messages and update the GUI by using <code>SwingUtilities.invokeLater()</code>.</li>
</ul>
<p><strong>Heartbeat Thread</strong>:</p>
<ul>
<li>This sends the &ldquo;heartbeat&rdquo; message every 5 seconds.</li>
<li>It runs independent to the other threads and user interactions.</li>
</ul>
<p>The main reason for this multi-threading is to ensure tha the GUI doesn&rsquo;t freeze everytime the <code>socket.receive()</code> function is called to listen for UDP packets. Here&rsquo;s how all this works:</p>
<h3 id="send-class">Send Class
</h3><p>The <code>Send</code> class is a simple class to provide functions to send commands to the ESP32:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">mcp</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.DatagramPacket</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.DatagramSocket</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.InetAddress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.SocketException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.UnknownHostException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Send</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">DatagramSocket</span><span class="w"> </span><span class="n">espSendSocket</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">espSendPortNumber</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">InetAddress</span><span class="w"> </span><span class="n">espSendIpAddr</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Gui</span><span class="w"> </span><span class="n">userInterface</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sendNotifications</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Constructor to set destination port/ipaddr variables and initialise</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// espSendSocket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Send</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">espSendPortNumber</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">espSendIpAddr</span><span class="p">,</span><span class="w"> </span><span class="n">Gui</span><span class="w"> </span><span class="n">userInterface</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userInterface</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">userInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userInterface</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">sendNotifications</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">espSendPortNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">espSendPortNumber</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">espSendIpAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InetAddress</span><span class="p">.</span><span class="na">getByName</span><span class="p">(</span><span class="n">espSendIpAddr</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">espSendSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DatagramSocket</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnknownHostException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Ran into an UnknownHostException: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SocketException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Ran into an SocketException: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Create message based on the string and send it to the destination as per the</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// global variables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">sendBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getBytes</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">DatagramPacket</span><span class="w"> </span><span class="n">sendPacket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DatagramPacket</span><span class="p">(</span><span class="n">sendBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">sendBuffer</span><span class="p">.</span><span class="na">length</span><span class="p">,</span><span class="w"> </span><span class="n">espSendIpAddr</span><span class="p">,</span><span class="w"> </span><span class="n">espSendPortNumber</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">espSendSocket</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">sendPacket</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sendNotifications</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">userInterface</span><span class="p">.</span><span class="na">showNotification</span><span class="p">(</span><span class="s">&#34;Sent message to esp: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Sent message to esp: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Ran into an IOException: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This class won&rsquo;t cause any thread or concurrency issues since the UDP sockets can be shared and be used by the GUI thread and the heartbeat thread.</p>
<h3 id="receive-class">Receive Class
</h3><p>The <code>Receive</code> class runs on its own thread (uses the <code>Runnable</code> interface) and listens for messages:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Receive</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">DatagramSocket</span><span class="w"> </span><span class="n">socket</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">volatile</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Gui</span><span class="w"> </span><span class="n">userInterface</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">Receive</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">Gui</span><span class="w"> </span><span class="n">gui</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DatagramSocket</span><span class="p">(</span><span class="n">port</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">userInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gui</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Receive thread listening on port &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SocketException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Failed to create receiver: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">running</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DatagramPacket</span><span class="w"> </span><span class="n">packet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DatagramPacket</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="c1">// Blocks here until packet arrives</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">socket</span><span class="p">.</span><span class="na">receive</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">packet</span><span class="p">.</span><span class="na">getData</span><span class="p">(),</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">packet</span><span class="p">.</span><span class="na">getLength</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">).</span><span class="na">trim</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Received: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">parseMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">running</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Receive error: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">parseMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;STATUS:&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">handleStatusUpdate</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;EMERGENCY_STOP:&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">handleEmergencyStop</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;ERROR:&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">handleErrorMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;WARNING:&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">handleWarningMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;SYSTEM_UPDATE:&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">handleSystemUpdate</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">socket</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">socket</span><span class="p">.</span><span class="na">isClosed</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">socket</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The main part here is that <code>socket.receive(packet)</code> blocks the entire thread until a packet arrives, but this won&rsquo;t stop the GUI from running. Once a message arrives, it gets parsed and updated in the GUI using <code>SwingUtiliteis.invokeLater()</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleStatusUpdate</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Parse the message</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">).</span><span class="na">trim</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;\\|&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Update GUI on the Event Dispatch Thread</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">SwingUtilities</span><span class="p">.</span><span class="na">invokeLater</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">parts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">keyValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">part</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keyValue</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyValue</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">.</span><span class="na">trim</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyValue</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">.</span><span class="na">trim</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;MODE&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">userInterface</span><span class="p">.</span><span class="na">updateMode</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;BRIDGE&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">userInterface</span><span class="p">.</span><span class="na">updateBridgeState</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// ... Etc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="heartbeat-class">Heartbeat Class
</h3><p>This thread runs indepedent to the other the other threads so that the ESP32 knows the connection with the Java program is alive:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">mcp</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Timer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.TimerTask</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Heartbeat</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">heartBeatSendObject</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Timer</span><span class="w"> </span><span class="n">heartBeatTimer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Gui</span><span class="w"> </span><span class="n">userInterface</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Heartbeat interval in milliseconds (2 seconds)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">HEARTBEAT_INTERVAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">2000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Initial delay before first heartbeat (1 second)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">INITIAL_DELAY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Heartbeat</span><span class="p">(</span><span class="n">Send</span><span class="w"> </span><span class="n">heartbeatObject</span><span class="p">,</span><span class="w"> </span><span class="n">Gui</span><span class="w"> </span><span class="n">userInterface</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">heartBeatSendObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heartbeatObject</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">userInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userInterface</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Make it a daemon thread</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">heartBeatTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Timer</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// scheduleAtFixedRate for repeating task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">heartBeatTimer</span><span class="p">.</span><span class="na">scheduleAtFixedRate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TimerTask</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">heartBeatSendObject</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="s">&#34;heartbeat&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userInterface</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">userInterface</span><span class="p">.</span><span class="na">updateMessageLog</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="s">&#34;SENT: heartbeat&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Error sending heartbeat: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="n">INITIAL_DELAY</span><span class="p">,</span><span class="w"> </span><span class="n">HEARTBEAT_INTERVAL</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stopHeartbeat</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">heartBeatTimer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">heartBeatTimer</span><span class="p">.</span><span class="na">cancel</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Heartbeat stopped&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="main">Main
</h3><p>Inside the <code>main</code> method the <code>GUI</code> class is created. Then the receiveThread is created and ran. After this, two <code>Send</code> objects are created, one for the GUI and one for the heartBeat. The <code>guiSendObject</code> is passed into the <code>intialiseSender</code> method of the <code>GUI</code> class as is the <code>heartBeatSendObject</code> to the <code>HeartBeatThread</code>. And that&rsquo;s pretty much all the threads for the Java program.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">mcp</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RECEIVE_PORT_NUMBER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">3032</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SEND_PORT_NUMBER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">3031</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Put 127.0.0.1 for Wokwi Simulator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// private static final String SEND_IP_ADDR = &#34;127.0.0.1&#34;;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">SEND_IP_ADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;10.237.91.181&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Create the GUI object first to get reference</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Gui</span><span class="w"> </span><span class="n">userInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Gui</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Create and run the thread to receive messages</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Receive</span><span class="w"> </span><span class="n">receiveThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Receive</span><span class="p">(</span><span class="n">RECEIVE_PORT_NUMBER</span><span class="p">,</span><span class="w"> </span><span class="n">userInterface</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">receiveThread</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Create the object to send GUI messages</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Send</span><span class="w"> </span><span class="n">guiSendObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Send</span><span class="p">(</span><span class="n">SEND_PORT_NUMBER</span><span class="p">,</span><span class="w"> </span><span class="n">SEND_IP_ADDR</span><span class="p">,</span><span class="w"> </span><span class="n">userInterface</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Create the object to send heartbeat messages</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Send</span><span class="w"> </span><span class="n">heartBeatSendObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Send</span><span class="p">(</span><span class="n">SEND_PORT_NUMBER</span><span class="p">,</span><span class="w"> </span><span class="n">SEND_IP_ADDR</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Initialise the GUI with the send object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">userInterface</span><span class="p">.</span><span class="na">initializeSender</span><span class="p">(</span><span class="n">guiSendObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Create and run the threat to send heartbeat messages</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Heartbeat</span><span class="w"> </span><span class="n">heartBeatThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Heartbeat</span><span class="p">(</span><span class="n">heartBeatSendObject</span><span class="p">,</span><span class="w"> </span><span class="n">userInterface</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">heartBeatThread</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">addShutdownHook</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Shutting down...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">heartBeatThread</span><span class="p">.</span><span class="na">stopHeartbeat</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">receiveThread</span><span class="p">.</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="controls-and-displays">Controls and Displays
</h2><p>For the actual controls and display, we have a <code>Gui</code> class which creates all the components (animation, buttons and message log). Other than that there isn&rsquo;t really too much to the controls and display, it&rsquo;s just code using the <code>Swing</code> library to make everything look nice and pretty (no point in going through that code because it&rsquo;s just UI stuff). The annoying part about this is that the Java GUI wasn&rsquo;t responsive to different screen sizes so some of the time went to making the changes I made on my PC look nice on my laptop. This is what the GUI looks like when connected to the ESP32:</p>
<p><img src="/p/engg3000-vertical-lift-bridge/images/gui.png"
	width="1916"
	height="1031"
	srcset="/p/engg3000-vertical-lift-bridge/images/gui_hu17723801247368059935.png 480w, /p/engg3000-vertical-lift-bridge/images/gui_hu8458501680173493632.png 1024w"
	loading="lazy"
	
		alt="GUI running with Wokwi Simulation"
	
	
		class="gallery-image" 
		data-flex-grow="185"
		data-flex-basis="446px"
	
></p>
<h1 id="lessons-learnt">Lessons Learnt
</h1><p>This project has taught me so much about designing a system from scratch and about embedded systems (something I definitely want to explore more):</p>
<ol>
<li>
<p><strong>EMI is a real problem.</strong> I was pretty suprised when we discovered the issue with the motors causing EMI and messing up the readings from the ultrasonic sensors. The sensors just wouldn&rsquo;t be able to get a reading no matter how much we changed the time of the pulse being sent. The solution (stop-measure-restart cycle) wasn&rsquo;t optimal but given the time constraint we had when we discovered the problem it was the best option we had. This taught me how important it is to consider the physical environment when working with sensors and that the simulation won&rsquo;t always match the actual run (I knew this but wasn&rsquo;t expecting it in this way).</p>
</li>
<li>
<p><strong>Timing windows need a lot of buffer time.</strong> The initial bridge sequence time ran fine with the Wokwi simulations. But since the motors took longer to get the bridge in the desired state this cause false failures. I had to extend the window to 25-38 seconds to stop these false failures. It took me a while to realise this since it wasn&rsquo;t obvious from the logs. The lesson here is to allow the mechanical systems to properly stablise and that the software should account for this rather than expecting the perfect outcome.</p>
</li>
<li>
<p><strong>How useful queueing is.</strong> Instead of executing all the mode changes, bridge/gate changes and override commands instantly, queueing them not only prevented race conditions but allowed for checking safety conditions before executing the operation. This made life a lot easier and definitely avoided a lot of problems we would&rsquo;ve encountered in a non-queue based approach.</p>
</li>
</ol>
<h1 id="things-id-do-differently">Things I&rsquo;d Do Differently
</h1><ol>
<li>
<p><strong>Separate Repositories</strong>. Initially we actually had a single repository for both programs. But this caused a lot of issues with VSCode tasks and Java struggling with building the project. I would have a separate code base from the beginning if I had the option.</p>
</li>
<li>
<p><strong>Early Documentation</strong>. I&rsquo;d definitely update the doco as the project went on and not cram it all right before the assignment report was due. This would&rsquo;ve also helped with creating this post.</p>
</li>
<li>
<p><strong>Unit Testing using Wokwi</strong>. Initially I only tested by relying on the actual ESP32 but I couldn&rsquo;t take the full setup home so this meant I could only test for a couple hours every week. I wish I knew about Wokwi before and simulated all the test cases/scenarios sooner. I&rsquo;d also try and find a way to make a pipeline for running these tests.</p>
</li>
<li>
<p><strong>Communication</strong>. This is a non-technical point but we ended up having to cram all the testing right before the demonstration because the Structures team wasn&rsquo;t prepared. Had we had better Communication with them we would&rsquo;ve avoided this.</p>
</li>
</ol>
<h1 id="conclusion">Conclusion
</h1><p>This project was insanely fun and the things I learnt are invaluable. All the late night debugging sessions paid off and our demonstration was pretty smooth other than a mechnical issue we had. For a 15 week university project, I&rsquo;m really proud of what we created from scratch and a budget of $100. I&rsquo;m also really happy with the multi-threaded design of both programs and safety architecture that we implemented. If I had to take away one thing from this project it would be our &ldquo;what if&rdquo; approach. This approach ensured that we were always proactive with all the problems rather than reactive. All the source code is available on Github as mentioned <a class="link" href="#what-was-the-project" >above</a>.</p>
<p>I hope you enjoyed this post as much as I enjoyed in creating the project.</p>

</section>


    <footer class="article-footer">
    
        <section class = "article-tags">
            <div class = "article-tag-details">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z"/>
                    <path d="M11 3L20 12a1.5 1.5 0 0 1 0 2L14 20a1.5 1.5 0 0 1 -2 0L3 11v-4a4 4 0 0 1 4 -4h4" />
                    <circle cx="9" cy="9" r="2" />
                </svg>
                <div class = "article-tags">
                    
    <section class="article-tags">
        
            <a href="/tags/university-project/">University Project</a>
        
            <a href="/tags/c&#43;&#43;/">C&#43;&#43;</a>
        
            <a href="/tags/java/">Java</a>
        
            <a href="/tags/esp32/">ESP32</a>
        
            <a href="/tags/hardware/">Hardware</a>
        
            <a href="/tags/networks/">Networks</a>
        
    </section>

                </div>
            </div>
        </section>
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z"/>
            <circle cx="12" cy="12" r="9" />
            <path d="M14.5 9a3.5 4 0 1 0 0 6" />
        </svg>
          
        <span><a href = "https://creativecommons.org/licenses/by/4.0/">This post is licensed under CC BY 4.0</a></span>
    </section>
    
</footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 MT12. Some rights reserved.
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1cb698c1a3a3f4d5b2bd7c141eab09a0dd3768e53986f081c03622a5ab22acc0.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
